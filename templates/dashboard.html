<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NutriChain Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind, Leaflet, Lucide -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .nav-item {
      display: block;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      color: #9ca3af;
    }
    .nav-item:hover {
      background: #111827;
      color: #e5e7eb;
    }
    .nav-item.active {
      background: #111827;
      color: #f97316;
    }
    .dashboard-layout {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      gap: 1.5rem;
    }
    @media (max-width: 768px) {
      .dashboard-layout {
        grid-template-columns: 1fr;
      }
    }
    .sidebar {
      border-right: 1px solid #1f2933;
      padding-right: 1rem;
    }
    @media (max-width: 768px) {
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #1f2933;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }
    }
    .main-content {
      min-height: 0;
    }
    .stats-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .stat-card {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 0.75rem;
      padding: 0.9rem 1rem;
    }
    #map {
      width: 100%;
      height: 360px;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      overflow: hidden;
    }
    #mapFullscreen {
      width: 100%;
      height: 100%;
    }

    /* Modale Web3Modal centr√©e */
    body w3m-modal {
      position: fixed !important;
      inset: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 100000 !important;
      background: transparent !important;
    }

    body.w3m-open {
      overflow: hidden;
    }
  </style>

  <!-- Polyfills n√©cessaires -->
  <script>
    window.global = window;
    window.process = { env: { NODE_ENV: "production" } };
  </script>

  <!-- Web3Modal (ethers v4) -->
  <script type="module">
    import {
      createWeb3Modal,
      defaultConfig,
    } from "https://esm.sh/@web3modal/ethers@4.0.0?bundle";

    const projectId = "6ada14d4e40d08d278a39c212bf50ce9";

    const mainnet = {
      chainId: 1,
      name: "Ethereum",
      currency: "ETH",
      explorerUrl: "https://etherscan.io",
      rpcUrl: "https://cloudflare-eth.com",
    };

    const metadata = {
      name: "NutriChain",
      description: "NutriChain Dashboard",
      url: "https://nutrichain.org",
      icons: ["https://avatars.githubusercontent.com/u/37784886"],
    };

    let modal;
    let currentStakingKey = null; // Hedera ou EVM utilis√© pour staking/gouv
    let currentEvmAddress = null; // adresse EVM connect√©e

    // Notifie le backend (login + Firestore)
    async function notifyBackend(address) {
      if (!address) return;
      try {
        await fetch("/api/login_wallet", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ wallet: address }),
        });
        updateUserDashboard(address);
      } catch (e) {
        console.error("Backend login error", e);
      }
    }

    // Met √† jour l'UI avec l'adresse + gouv + staking
    async function updateUserDashboard(address) {
      const btn = document.getElementById("wcConnectBtn");
      if (btn) {
        btn.innerHTML = `<i data-lucide="user" class="w-3.5 h-3.5"></i> ${address.substring(
          0,
          4
        )}...${address.substring(address.length - 4)}`;
      }
      const addrEl = document.getElementById("userAddress");
      if (addrEl) addrEl.textContent = address;

      // 1. Lookup EVM -> Hedera via /api/evm_to_hedera
      let hederaAccount = null;
      try {
        const res = await fetch(`/api/evm_to_hedera?evm=${address}`);
        if (res.ok) {
          const data = await res.json();
          hederaAccount = data.hedera || null;
        }
      } catch (e) {
        console.error("evm_to_hedera error", e);
      }

      // 2. Construire les liens gouv/donate
      const govLink = document.getElementById("governanceLink");
      const donateLink = document.getElementById("donateLink");

      if (hederaAccount) {
        if (govLink)
          govLink.href = `/governance?account=${encodeURIComponent(
            hederaAccount
          )}`;
        if (donateLink)
          donateLink.href = `/donate?account=${encodeURIComponent(
            hederaAccount
          )}`;
      } else {
        if (govLink)
          govLink.href = `/governance?account=${encodeURIComponent(address)}`;
        if (donateLink)
          donateLink.href = `/donate?account=${encodeURIComponent(address)}`;
      }

      // 3. Staking : on utilise la cl√© Hedera si dispo, sinon l'adresse EVM
      const stakingKey = hederaAccount || address;
      currentStakingKey = stakingKey;
      await loadStakingInfo(stakingKey);

      // 4. Mettre √† jour APY si stak√©
      try {
        const res = await fetch(`/api/staking_info/${stakingKey}`);
        if (res.ok) {
          const data = await res.json();
          if (data.staked) {
            const apyEl = document.getElementById("annualYield");
            if (apyEl) {
              apyEl.textContent = (data.apy * 100).toFixed(2) + "%";
              apyEl.classList.add("text-emerald-400");
            }
          }
        }
      } catch (e) {
        console.error(e);
      }
    }

    try {
      modal = createWeb3Modal({
        ethersConfig: defaultConfig({ metadata }),
        chains: [mainnet],
        projectId,
        enableAnalytics: true,
      });

      const btn = document.getElementById("wcConnectBtn");
      if (btn) {
        btn.innerHTML =
          '<i data-lucide="wallet" class="w-3.5 h-3.5"></i> Connect Wallet';
        btn.disabled = false;
        btn.classList.remove("opacity-50", "cursor-not-allowed");

        window.openNutriConnectModal = async () => {
          await modal.open();
        };
      }

      // S'abonner aux changements
      modal.subscribeProvider((state) => {
        if (state.isConnected && state.address) {
          console.log("Connect√©:", state.address);
          currentEvmAddress = state.address;
          notifyBackend(state.address);
        } else {
          currentEvmAddress = null;
          const btn = document.getElementById("wcConnectBtn");
          if (btn) {
            btn.innerHTML =
              '<i data-lucide="wallet" class="w-3.5 h-3.5"></i> Connect Wallet';
          }
          const addrEl = document.getElementById("userAddress");
          if (addrEl) addrEl.textContent = "Not connected";
        }
      });
    } catch (err) {
      console.error("ERREUR CRITIQUE WALLET:", err);
      const btn = document.getElementById("wcConnectBtn");
      if (btn) {
        btn.innerHTML = "‚ö†Ô∏è Wallet error";
        btn.onclick = () => alert("Wallet error: " + err.message);
      }
    }

    // On expose la fonction de staking pour le script global
    window.__setStakingKey = (k) => {
      currentStakingKey = k;
    };

    // Exposer currentEvmAddress au script global si besoin
    window.__getCurrentEvm = () => currentEvmAddress;
  </script>
</head>

<body class="bg-slate-950 text-slate-100">
<div class="min-h-screen flex flex-col">
  <header
    class="border-b border-[#30363d] bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950"
  >
    <div
      class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <div class="flex items-center gap-3">
        <div
          class="h-9 w-9 rounded-lg bg-emerald-500/20 border border-emerald-500/40 flex items-center justify-center"
        >
          <span class="text-emerald-400 font-bold text-lg">N</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold tracking-tight text-white">
            NutriChain Dashboard
          </h1>
          <p class="text-xs text-slate-400">
            Tracking NCHAIN treasury, blocks, and distributed meals impact.
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
         <!-- Make a donation button (header) -->
         <a
          href="/donate"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-orange-500 hover:bg-orange-400 text-xs font-semibold text-white"
        >
          Make a donation
        </a>
        <!-- Buy NCHAIN button (header) -->
        <a
          href="https://www.saucerswap.finance/swap/HBAR/0.0.10136204"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white"
        >
          Buy NCHAIN
        </a>
      </div>
    </div>
  </header>

  <div class="flex-1 bg-slate-950">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <div class="dashboard-layout">
        <aside class="sidebar">
          <h2
            class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wide"
          >
            Navigation
          </h2>
          <a href="#statsSection" class="nav-item active">Statistics</a>
          <a href="#chainSection" class="nav-item">Chain / Treasury</a>
          <a href="#mapSection" class="nav-item">Donations map</a>
          <a href="/wallet/" class="nav-item">My Wallet</a>
          <hr class="my-3 border-slate-800" />
          <a href="/donate" class="nav-item">Make a donation</a>
          <a href="/stake" class="nav-item">Stake NUTRI</a>
          <a href="/governance" class="nav-item" id="sidebarGovernanceLink">
            DAO governance
          </a>
        </aside>

        <main class="main-content">
          <section id="statsSection" class="section">
            <h2 class="text-xl font-semibold mb-4 text-white">Overview</h2>

            <div class="flex flex-wrap gap-2 mb-4 items-center">
              <a
                href="/donate"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white"
              >
                <i data-lucide="donate" class="w-3.5 h-3.5"></i> Make a donation
              </a>
              <a
                href="/stake"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-indigo-600 hover:bg-indigo-500 text-xs font-semibold text-white"
              >
                <i data-lucide="layers" class="w-3.5 h-3.5"></i> Stake
              </a>
              <a
                href="/wallet/"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md bg-orange-600 hover:bg-orange-500 text-xs font-semibold text-white"
              >
                <i data-lucide="wallet" class="w-3.5 h-3.5"></i> My Wallet
              </a>

              <div class="ml-auto flex gap-2 items-center">
                <button
                  id="wcConnectBtn"
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-600 bg-slate-900/70 text-xs font-medium text-slate-100 opacity-50 cursor-not-allowed"
                  disabled
                  onclick="window.openNutriConnectModal && window.openNutriConnectModal()"
                >
                  <i
                    data-lucide="loader-2"
                    class="w-3.5 h-3.5 animate-spin"
                  ></i>
                  Initializing...
                </button>

                <button
                  id="openNutriWalletBtn"
                  class="hidden md:inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-slate-700 bg-slate-950/70 hover:bg-slate-900 text-[11px] font-medium text-slate-300"
                  onclick="window.open('https://wallet.nutrichain.org/','_blank','noopener')"
                >
                  <i data-lucide="external-link" class="w-3 h-3"></i> Open app
                </button>
              </div>
            </div>

            <div class="stats-grid">
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">Meals distributed</h3>
                <div class="text-2xl font-semibold text-white mt-1"
                     id="mealsCount">
                  12,847
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  Based on reported NCHAIN donations.
                </p>
              </div>
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">NCHAIN treasury</h3>
                <div
                  class="text-2xl font-semibold text-emerald-400 mt-1"
                  id="nchain-balance"
                >
                  Loading...
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  Balance of account 0.0.10128148
                </p>
              </div>
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">Estimated impact</h3>
                <div class="text-2xl font-semibold text-orange-400 mt-1">
                  <span id="impactMeals">‚Äì</span> meals
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  Indicative conversion NCHAIN ‚Üí meals.
                </p>
              </div>
            </div>

            <div class="stats-grid mt-6">
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">Your address</h3>
                <div
                  class="text-sm font-mono text-slate-300 mt-1"
                  id="userAddress"
                >
                  Not connected
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  Connect a compatible wallet to participate in governance.
                </p>
              </div>
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">NUTRI price (USD)</h3>
                <div class="text-2xl font-semibold text-white mt-1"
                     id="nutri-price">
                  N/A
                </div>
                <p class="text-xs text-slate-500 mt-1"
                   id="nutriCoinSource">
                  Indicative value of the NUTRI token.
                </p>
              </div>
              <div class="stat-card">
                <h3 class="text-slate-400 text-sm">Annual yield</h3>
                <div
                  class="text-2xl font-semibold text-emerald-400 mt-1"
                  id="annualYield"
                >
                  7.25%
                </div>
                <p class="text-xs text-slate-500 mt-1">
                  Simulated APY for staking NUTRI.
                </p>
              </div>
            </div>

<div class="stats-grid mt-4">
  <div class="stat-card">
    <h3 class="text-slate-400 text-sm">Your voting NUTRI</h3>
    <div class="text-2xl font-semibold text-white mt-1"
         id="voting-power">
      0.00
    </div>
    <p class="text-xs text-slate-500 mt-1" id="userTokens">
      NUTRI counted for governance.
    </p>
  </div>

  <div class="stat-card">
    <h3 class="text-slate-400 text-sm">Total proposals submitted</h3>
    <div class="text-2xl font-semibold text-orange-400 mt-1"
         id="totalProposalsCount">
      0
    </div>
    <p class="text-xs text-slate-500 mt-1">
      Global history of NutriChain proposals.
    </p>
  </div>

  <div class="stat-card">
    <h3 class="text-slate-400 text-sm">
      Firestore connection status
    </h3>
    <div
      class="text-sm font-semibold text-red-400 mt-1"
      id="fallback-error-message"
    >
      Static mode (DAO simulation)
    </div>
    <p class="text-xs text-slate-500 mt-1">
      Real-time loading may be disabled in dev.
    </p>
  </div>

  <!-- Your NCHAIN wallet -->
  <div class="stat-card">
    <h3 class="text-slate-400 text-sm mb-1">Your NCHAIN wallet</h3>
    <label
      for="accountIdInput"
      class="text-xs text-slate-500"
      >Hedera account ID (e.g. 0.0.123456)</label
    >
    <div class="mt-1 flex gap-2">
      <input
        id="accountIdInput"
        type="text"
        class="flex-1 rounded-md bg-slate-900 border border-slate-700 px-2 py-1 text-xs text-slate-100 placeholder-slate-500"
        placeholder="0.0.xxxxx"
      />
      <button
        id="loadBalanceBtn"
        class="px-2.5 py-1 rounded-md bg-emerald-600 hover:bg-emerald-500 text-[11px] font-medium text-white"
      >
        Load
      </button>
    </div>
    <p
      class="text-xs text-slate-400 mt-2"
      id="balanceResult"
    >
      Enter your account ID to view your NCHAIN balance.
    </p>
    <p class="text-[11px] text-slate-500 mt-1">
      After loading your wallet, you can
      <a
        id="governanceLink"
        href="/governance"
        class="text-emerald-400 underline"
        >vote with this account</a
      >
      or
      <a
        id="donateLink"
        href="/donate"
        class="text-emerald-400 underline"
        >donate with this account</a
      >.
    </p>
  </div>

  <!-- Live network activity, dans la m√™me grille (donc √† C√îT√â sur grand √©cran) -->
  <div class="stat-card">
    <h3 class="text-slate-400 text-sm mb-1">Live network activity</h3>
    <p class="text-xs text-slate-500 mb-2">
      Last donations, votes and staking events recorded on-chain.
    </p>
    <div
      id="activityList"
      class="bg-slate-950/50 rounded-md border border-slate-800/60 p-2 h-28 overflow-y-auto text-[11px] text-slate-300"
    >
      <p class="text-slate-500 flex items-center gap-1">
        <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
        Loading recent activity‚Ä¶
      </p>
    </div>
  </div>
</div>

            <!-- Bloc Staking -->
            <div class="stat-card mt-4">
              <h3 class="text-slate-400 text-sm mb-1">Staking NCHAIN</h3>
              <p class="text-xs text-slate-500 mb-2">
                Stake your NCHAIN to earn rewards. Uses the same identifier as for governance (Hedera account or EVM address).
              </p>
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <input
                  id="stakeAmountInput"
                  type="number"
                  min="0"
                  step="0.01"
                  class="w-32 rounded-md bg-slate-900 border border-slate-700 px-2 py-1 text-xs text-slate-100 placeholder-slate-500"
                  placeholder="Amount"
                />
                <button
                  id="stakeBtn"
                  class="px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-[11px] font-medium text-white"
                >
                  Stake
                </button>
                <button
                  id="unstakeBtn"
                  class="px-3 py-1.5 rounded-md bg-rose-600 hover:bg-rose-500 text-[11px] font-medium text-white"
                >
                  Unstake
                </button>
              </div>
              <p class="text-[11px] text-slate-400" id="stakingStatus">
                Connect your wallet to load staking info.
              </p>
            </div>

            <!-- Bloc Link Hedera account -->
            <div class="stat-card mt-4">
              <h3 class="text-slate-400 text-sm mb-1">Link Hedera account</h3>
              <p class="text-xs text-slate-500 mb-2">
                Connect your EVM wallet, then link the Hedera account ID that holds your NCHAIN (format <code>0.0.xxxx</code>).
              </p>
              <div class="flex flex-wrap items-center gap-2 mb-2">
                <input
                  id="linkHederaInput"
                  type="text"
                  class="w-40 rounded-md bg-slate-900 border border-slate-700 px-2 py-1 text-xs text-slate-100 placeholder-slate-500"
                  placeholder="0.0.xxxx"
                />
                <button
                  id="linkHederaBtn"
                  class="px-3 py-1.5 rounded-md bg-sky-600 hover:bg-sky-500 text-[11px] font-medium text-white"
                >
                  Link account
                </button>
              </div>
              <p class="text-[11px] text-slate-400" id="linkHederaStatus">
                Connect your EVM wallet first, then enter your Hedera account.
              </p>
            </div>

            <div class="stats-grid mt-6">
              <div class="stat-card col-span-1 md:col-span-2">
                <h3 class="text-slate-400 text-sm mb-2">
                  Recent NutriChain blocks
                </h3>
                <p class="text-xs text-slate-500 mb-2">
                  Overview of the latest blocks on NutriChain.
                </p>
                <div class="overflow-x-auto">
                  <table
                    class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg"
                  >
                    <thead class="bg-slate-900 text-slate-400">
                      <tr>
                        <th class="px-2 py-1 text-left">#</th>
                        <th class="px-2 py-1 text-left">Hash</th>
                        <th class="px-2 py-1 text-left">Tx</th>
                        <th class="px-2 py-1 text-left">Date</th>
                      </tr>
                    </thead>
                    <tbody id="blocksTableBody">
                      <tr>
                        <td class="px-2 py-1 border-t border-slate-800">1</td>
                        <td
                          class="px-2 py-1 border-t border-slate-800 text-xs"
                        >
                          0xabc...123
                        </td>
                        <td class="px-2 py-1 border-t border-slate-800">3</td>
                        <td class="px-2 py-1 border-t border-slate-800">
                          2025-12-03 14:00
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="stat-card">
                <h3 class="text-slate-400 text-sm mb-2">Totals by region</h3>
                <p class="text-xs text-slate-500 mb-2">
                  Aggregated totals from donations recorded on NutriChain.
                </p>
                <div class="overflow-x-auto">
                  <table
                    class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg"
                  >
                    <thead class="bg-slate-900 text-slate-400">
                      <tr>
                        <th class="px-2 py-1 text-left">Region</th>
                        <th class="px-2 py-1 text-right">
                          Meals funded (NUTRI)
                        </th>
                      </tr>
                    </thead>
                    <tbody id="regionsTableBody">
                      <tr>
                        <td class="px-2 py-1 border-t border-slate-800">
                          West Africa
                        </td>
                        <td
                          class="px-2 py-1 border-t border-slate-800 text-right"
                        >
                          0
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <p class="text-[11px] text-slate-500 mt-2">
                  Each token = 1 meal distributed.
                </p>
              </div>
            </div>
          </section>

          <section id="chainSection" class="section mt-10">
            <h2 class="text-xl font-semibold mb-4 text-white">
              NCHAIN chain / blockchain
            </h2>
            <p class="text-sm text-slate-400 mb-3">
              Details about the NCHAIN token, treasury account, and read-only
              access via Mirror Node.
            </p>
            <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
              <li>NCHAIN token ID: 0.0.10136204</li>
              <li>Tracked treasury account: 0.0.10128148</li>
              <li>Balances read via Mirror Node (read-only)</li>
            </ul>
            <p class="text-sm text-slate-400 mt-3">
              Linked wallet: <span id="linkedWalletSpan">unknown</span>
            </p>
          </section>

          <section id="mapSection" class="section mt-10">
            <h2 class="text-xl font-semibold mb-4 text-white">
              Donations & canteens map
            </h2>
            <p class="text-sm text-slate-400 mb-3">
              Location of some food projects supported by NCHAIN donations.
            </p>
            <div class="relative">
              <div id="map" class="cursor-pointer"></div>
              <button
                id="mapFullscreenBtn"
                class="absolute top-2 right-2 z-20 px-2 py-1 rounded bg-black/60 text-xs text-white"
              >
                Fullscreen
              </button>
            </div>
            <div
              id="mapOverlay"
              class="fixed inset-0 z-40 bg-black/90 hidden"
            >
              <div class="absolute top-2 right-2">
                <button
                  id="mapOverlayClose"
                  class="px-3 py-1 rounded bg-slate-800 text-xs text-white"
                >
                  Close
                </button>
              </div>
              <div id="mapFullscreen" class="w-full h-full mt-8"></div>
            </div>
          </section>
        </main>
      </div>

      <footer
        class="mt-16 border-t border-slate-800 bg-slate-950/80"
      >
        <div
          class="mx-auto max-w-6xl px-4 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
        >
          <div class="text-xs text-slate-400">
            <p class="font-semibold text-slate-200">NutriChain</p>
            <p class="mt-1">
              Transparent humanitarian treasury on Hedera.
            </p>
            <p class="mt-1">
              ¬© 2025 NutriChain. All rights reserved.
            </p>
          </div>
          <div class="flex items-center gap-5">
            <a
              href="https://x.com/nutrichain_"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-slate-100 transition"
              >X</a
            >
            <a
              href="https://t.me/NutriChainTeam"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-slate-100 transition"
              >@NutriChainTeam</a
            >
          </div>
        </div>
      </footer>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  let currentAccountId = null;
  let map;
  let fullscreenMap;
  let currentStakingKey = null;
  let currentEvmAddress = null;

  const locations = [
    { lat: 48.8566, lng: 2.3522, name: "Paris, France", meals: 127, org: "Restos du C≈ìur" },
    { lat: 33.5138, lng: 36.2765, name: "Damascus, Syria", meals: 50, org: "Cantine Al-Amal" },
    { lat: 9.032, lng: 38.7469, name: "Addis Ababa, Ethiopia", meals: 89, org: "WFP programme" },
    { lat: 28.6139, lng: 77.209, name: "New Delhi, India", meals: 234, org: "Akshaya Patra" }
  ];

  async function loadNchainBalance(defaultAccount = "0.0.10128148") {
    try {
      const res = await fetch(`/nchain_balance/${defaultAccount}`);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      const el = document.getElementById("nchain-balance");
      if (el) {
        const bal = data.balance ?? 0;
        const symbol = data.symbol || "NCHAIN";
        el.textContent = `${bal.toLocaleString("en-US")} ${symbol}`;
      }
      const impactEl = document.getElementById("impactMeals");
      if (impactEl) {
        const bal = data.balance ?? 0;
        impactEl.textContent = bal.toLocaleString("en-US");
      }
    } catch (e) {
      const el = document.getElementById("nchain-balance");
      if (el) el.textContent = "Loading error";
      console.error(e);
    }
  }

  function initMap() {
    map = L.map("map").setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap",
    }).addTo(map);
    locations.forEach((loc) => {
      const marker = L.marker([loc.lat, loc.lng]).addTo(map);
      marker.bindPopup(
        `<div style="color:#e5e7eb;"><strong>${loc.name}</strong><br><span style="color:#10b981;">üçΩÔ∏è ${loc.meals} meals distributed</span><br><small>${loc.org}</small></div>`
      );
    });
  }

  function setupMapFullscreen() {
    const btn = document.getElementById("mapFullscreenBtn");
    const overlay = document.getElementById("mapOverlay");
    const closeBtn = document.getElementById("mapOverlayClose");
    if (!btn || !overlay || !closeBtn) return;

    btn.addEventListener("click", () => {
      overlay.classList.remove("hidden");
      if (!fullscreenMap) {
        fullscreenMap = L.map("mapFullscreen").setView([20, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap",
        }).addTo(fullscreenMap);
        locations.forEach((loc) => {
          const marker = L.marker([loc.lat, loc.lng]).addTo(fullscreenMap);
          marker.bindPopup(
            `<div style="color:#e5e7eb;"><strong>${loc.name}</strong><br><span style="color:#10b981;">üçΩÔ∏è ${loc.meals} meals distributed</span><br><small>${loc.org}</small></div>`
          );
        });
      }
      setTimeout(() => fullscreenMap.invalidateSize(), 200);
    });

    closeBtn.addEventListener("click", () => {
      overlay.classList.add("hidden");
    });
  }

  function setupSimpleWalletBalance() {
    const input = document.getElementById("accountIdInput");
    const btn = document.getElementById("loadBalanceBtn");
    const out = document.getElementById("balanceResult");
    if (!input || !btn || !out) return;

    btn.addEventListener("click", () => {
      const accountId = input.value.trim();
      if (!accountId) {
        out.textContent = "Please enter a Hedera account ID.";
        currentAccountId = null;
        return;
      }
      out.textContent = "Loading...";
      fetch(`/nchain_balance/${accountId}`)
        .then((res) => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then((data) => {
          const bal = data.balance ?? 0;
          const symbol = data.symbol || "NCHAIN";
          out.textContent = `Balance for ${accountId}: ${bal.toLocaleString(
            "en-US"
          )} ${symbol}`;
          currentAccountId = data.account_id || accountId;

          const vp = document.getElementById("voting-power");
          if (vp) vp.textContent = bal.toLocaleString("en-US");

          const govLink = document.getElementById("governanceLink");
          const donateLink = document.getElementById("donateLink");
          if (currentAccountId) {
            if (govLink)
              govLink.href = `/governance?account=${encodeURIComponent(
                currentAccountId
              )}`;
            if (donateLink)
              donateLink.href = `/donate?account=${encodeURIComponent(
                currentAccountId
              )}`;
          }
        })
        .catch((err) => {
          console.error(err);
          out.textContent = "Error loading balance. Check the account ID.";
          currentAccountId = null;
        });
    });
  }

  async function loadStakingInfo(walletKey) {
    const statusEl = document.getElementById("stakingStatus");
    currentStakingKey = walletKey;
    if (!walletKey) {
      if (statusEl)
        statusEl.textContent = "Connect your wallet to load staking info.";
      return;
    }
    try {
      const res = await fetch(`/api/staking_info/${walletKey}`);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (data.staked) {
        if (statusEl) {
          statusEl.textContent =
            `Staked: ${data.amount} NCHAIN, pending rewards: ${data.pending_rewards.toFixed(
              4
            )} NCHAIN (APY ${(data.apy * 100).toFixed(2)}%).`;
        }
      } else {
        if (statusEl) statusEl.textContent = "No active stake for this wallet.";
      }
    } catch (e) {
      console.error(e);
      if (statusEl) statusEl.textContent = "Error loading staking info.";
    }
  }

  function setupStakingControls() {
    const stakeBtn = document.getElementById("stakeBtn");
    const unstakeBtn = document.getElementById("unstakeBtn");
    const amountInput = document.getElementById("stakeAmountInput");
    const statusEl = document.getElementById("stakingStatus");

    if (stakeBtn) {
      stakeBtn.addEventListener("click", async () => {
        if (!currentStakingKey) {
          if (statusEl) statusEl.textContent = "Connect your wallet first.";
          return;
        }
        const amount = parseFloat(amountInput.value || "0");
        if (!amount || amount <= 0) {
          if (statusEl) statusEl.textContent = "Enter a valid amount to stake.";
          return;
        }
        try {
          if (statusEl) statusEl.textContent = "Sending stake transaction...";
          const res = await fetch("/api/stake", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              wallet: currentStakingKey,
              amount: amount,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            if (statusEl)
              statusEl.textContent = data.error || "Error while staking.";
            return;
          }
          if (statusEl)
            statusEl.textContent = `Stake successful: ${data.amount} NCHAIN.`;
          loadStakingInfo(currentStakingKey);
        } catch (e) {
          console.error(e);
          if (statusEl) statusEl.textContent = "Error while staking.";
        }
      });
    }

    if (unstakeBtn) {
      unstakeBtn.addEventListener("click", async () => {
        if (!currentStakingKey) {
          if (statusEl) statusEl.textContent = "Connect your wallet first.";
          return;
        }
        try {
          if (statusEl) statusEl.textContent = "Sending unstake transaction...";
          const res = await fetch("/api/unstake", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: currentStakingKey }),
          });
          const data = await res.json();
          if (!res.ok) {
            if (statusEl)
              statusEl.textContent = data.error || "Error while unstaking.";
            return;
          }
          if (statusEl)
            statusEl.textContent =
              `Unstake successful. Returned: ${data.staked_amount} NCHAIN, rewards earned: ${data.reward.toFixed(
                4
              )} NCHAIN.`;
          loadStakingInfo(currentStakingKey);
        } catch (e) {
          console.error(e);
          if (statusEl) statusEl.textContent = "Error while unstaking.";
        }
      });
    }
  }

  function setupLinkHederaControls() {
    const btn = document.getElementById("linkHederaBtn");
    const input = document.getElementById("linkHederaInput");
    const statusEl = document.getElementById("linkHederaStatus");

    if (!btn || !input || !statusEl) return;

    btn.addEventListener("click", async () => {
      if (!currentEvmAddress) {
        statusEl.textContent = "Please connect your EVM wallet first.";
        statusEl.className = "text-[11px] text-rose-400";
        return;
      }

      const hedera = input.value.trim();
      if (!hedera || !/^0\.0\.\d+$/.test(hedera)) {
        statusEl.textContent = "Enter a valid Hedera account ID (0.0.xxxx).";
        statusEl.className = "text-[11px] text-rose-400";
        return;
      }

      try {
        statusEl.textContent = "Linking account...";
        statusEl.className = "text-[11px] text-slate-400";

        const res = await fetch("/api/link_hedera", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ evm: currentEvmAddress, hedera: hedera }),
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || "Error while linking account.";
          statusEl.className = "text-[11px] text-rose-400";
          return;
        }

        statusEl.textContent = `Linked! EVM ${currentEvmAddress.substring(
          0,
          6
        )}... ‚Üí Hedera ${hedera}.`;
        statusEl.className = "text-[11px] text-emerald-400";

        const govLink = document.getElementById("governanceLink");
        const donateLink = document.getElementById("donateLink");
        if (govLink)
          govLink.href = `/governance?account=${encodeURIComponent(hedera)}`;
        if (donateLink)
          donateLink.href = `/donate?account=${encodeURIComponent(hedera)}`;

        currentStakingKey = hedera;
        loadStakingInfo(hedera);
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error while linking account.";
        statusEl.className = "text-[11px] text-rose-400";
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadNchainBalance();
    initMap();
    setupMapFullscreen();
    setupSimpleWalletBalance();
    setupStakingControls();
    setupLinkHederaControls();
    if (typeof lucide !== "undefined") lucide.createIcons();

    const treasuryId = "{{ treasury_id }}";
    fetch(`/nchain_balance/${treasuryId}`)
      .then((r) => (r.ok ? r.json() : null))
      .then((d) => {
        if (d) console.log("Treasury balance:", d);
      })
      .catch(console.error);

    fetch(`/linked_wallet/${treasuryId}`)
      .then((r) => {
        if (r.status === 404) return null;
        return r.ok ? r.json() : null;
      })
      .then((info) => {
        if (info) console.log("Linked wallet:", info);
      })
      .catch(console.error);
  });

  const observer = new MutationObserver(() => {
    const modal = document.querySelector("w3m-modal");
    if (!modal) return;
    const hasOpen =
      modal.shadowRoot &&
      modal.shadowRoot.querySelector('[data-testid="modal-overlay"]');
    if (hasOpen) {
      document.body.classList.add("w3m-open");
    } else {
      document.body.classList.remove("w3m-open");
    }
  });

  window.addEventListener("load", () => {
    const el = document.querySelector("w3m-modal");
    if (el) observer.observe(el, { childList: true, subtree: true });
  });
</script>
<script>
async function loadActivityFeed() {
  const container = document.getElementById("activityList");
  if (!container) return;

  try {
    const res = await fetch("/api/activity"); // Assurez-vous que cette route existe
    if (!res.ok) throw new Error("HTTP " + res.status);
    const items = await res.json();

    container.innerHTML = "";

    if (!items || !items.length) {
      container.innerHTML = '<p class="text-xs text-slate-500">No recent activity.</p>';
      return;
    }

    items.forEach((evt) => {
      const row = document.createElement("div");
      row.className = "flex items-start gap-3 py-2 border-b border-slate-800/50 last:border-0 text-xs";
      
      const ts = new Date(evt.ts).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
      
      let icon = "activity";
      let color = "text-slate-400";
      let content = "";

      if (evt.type === "donation") {
        icon = "heart";
        color = "text-rose-400";
        content = `<span class="${color}">Donation</span> of <strong class="text-white">${evt.amount} NUTRI</strong> from ${evt.wallet} to ${evt.region}`;
      } else if (evt.type === "vote") {
        icon = "vote";
        color = "text-sky-400";
        content = `<span class="${color}">Vote ${evt.choice.toUpperCase()}</span> on proposal #${evt.proposal_id} by ${evt.wallet}`;
      } else if (evt.type === "stake") {
        icon = "lock";
        color = "text-emerald-400";
        content = `<span class="${color}">Staked</span> <strong class="text-white">${evt.amount} NCHAIN</strong> by ${evt.wallet}`;
      } else {
        content = `Event from ${evt.wallet}`;
      }

      row.innerHTML = `
        <span class="text-slate-600 font-mono whitespace-nowrap pt-0.5">${ts}</span>
        <div class="flex-1 text-slate-300 break-all">${content}</div>
      `;
      
      container.appendChild(row);
    });
  } catch (e) {
    console.error("Activity feed error", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadActivityFeed();
  setInterval(loadActivityFeed, 10000); // Rafra√Æchir toutes les 10s
});
</script>

</body>
</html>

