<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NutriChain Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .nav-item {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .nav-item:hover {
            background: #111827;
            color: #e5e7eb;
        }
        .nav-item.active {
            background: #111827;
            color: #f97316;
        }
        .dashboard-layout {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 768px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }
        .sidebar {
            border-right: 1px solid #1f2933;
            padding-right: 1rem;
        }
        @media (max-width: 768px) {
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #1f2933;
                padding-bottom: 1rem;
                margin-bottom: 1.5rem;
            }
        }
        .main-content {
            min-height: 0;
        }
        .stats-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
        .stat-card {
            background: #020617;
            border: 1px solid #1f2937;
            border-radius: 0.75rem;
            padding: 0.9rem 1rem;
        }
        #map {
            width: 100%;
            height: 360px;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            overflow: hidden;
        }
        #mapFullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
<div class="min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="border-b border-[#30363d] bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-emerald-500/20 border border-emerald-500/40 flex items-center justify-center">
                    <span class="text-emerald-400 font-bold text-lg">N</span>
                </div>
                <div>
                    <h1 class="text-lg font-semibold tracking-tight text-white">NutriChain Dashboard</h1>
                    <p class="text-xs text-slate-400">
                        Suivi de la tr√©sorerie NCHAIN, des blocs et de l‚Äôimpact repas distribu√©s
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- CONTENU PRINCIPAL -->
    <div class="flex-1 bg-slate-950">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="dashboard-layout">
                <!-- SIDEBAR -->
                <aside class="sidebar">
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wide">
                        Navigation
                    </h2>

                    <a href="#statsSection" class="nav-item active">Statistiques</a>
                    <a href="#chainSection" class="nav-item">Cha√Æne / tr√©sorerie</a>
                    <a href="#mapSection" class="nav-item">Carte des dons</a>

                    <hr class="my-3 border-slate-800">

                    <a href="/donate" class="nav-item">Faire un don</a>
                    <a href="/stake" class="nav-item">Staker NUTRI</a>
                    <a href="/governance" class="nav-item">Gouvernance DAO</a>
                </aside>

                <!-- MAIN -->
                <main class="main-content">
                    <!-- SECTION STATS -->
                    <section id="statsSection" class="section">
                        <h2 class="text-xl font-semibold mb-4 text-white">Vue d‚Äôensemble</h2>

                        <!-- Boutons d‚Äôaction -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <a href="/donate"
                               class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold text-white flex items-center gap-2">
                                <i data-lucide="donate" class="w-4 h-4"></i>
                                Faire un don
                            </a>
                            <a href="/stake"
                               class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold text-white flex items-center gap-2">
                                <i data-lucide="layers" class="w-4 h-4"></i>
                                Staker des NUTRI
                            </a>
                            <button
                              id="connectWalletBtn"
                              class="px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-sm font-semibold text-gray-900 flex items-center gap-2">
                                <i data-lucide="plug-zap" class="w-4 h-4"></i>
                                Connecter un wallet Hedera
                            </button>
                            <button
                              id="wcConnectBtn"
                              class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-sm font-semibold text-gray-900 flex items-center gap-2">
                                <i data-lucide="wallet" class="w-4 h-4"></i>
                                Connect Wallet (WalletConnect)
                            </button>
                        </div>

                        <!-- STATS PRINCIPALES -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Repas distribu√©s</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="mealsCount">12 847</div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Bas√© sur les dons NCHAIN d√©clar√©s
                                </p>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Tr√©sorerie NCHAIN</h3>
                                <div class="text-2xl font-semibold text-emerald-400 mt-1" id="nchain-balance">Chargement...</div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Solde du compte 0.0.10128148
                                </p>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Impact estim√©</h3>
                                <div class="text-2xl font-semibold text-orange-400 mt-1">
                                    <span id="impactMeals">‚Äì</span> repas
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Conversion indicative NCHAIN ‚Üí repas
                                </p>
                            </div>
                        </div>

                        <!-- R√âSUM√â GOUVERNANCE -->
                        <div class="stats-grid" style="margin-top: 1.5rem;">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Votre Adresse</h3>
                                <div class="text-sm font-mono text-slate-300 mt-1" id="userAddress">
                                    Non Connect√©
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Connectez un wallet compatible pour participer √† la gouvernance.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Prix NUTRI (USD)</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="nutri-price">
                                    NA
                                </div>
                                <p class="text-xs text-slate-500 mt-1" id="nutriCoinSource">
                                    Valeur indicative du token NUTRI.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Taux de Rendement Annuel</h3>
                                <div class="text-2xl font-semibold text-emerald-400 mt-1" id="annualYield">
                                    7.25%
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    APY simul√© pour le staking de NUTRI.
                                </p>
                            </div>
                        </div>

                        <div class="stats-grid" style="margin-top: 1rem;">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Vos NUTRI votants</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="voting-power">
                                    0.00
                                </div>
                                <p class="text-xs text-slate-500 mt-1" id="userTokens">
                                    NUTRI pris en compte dans la gouvernance.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Total des propositions soumises</h3>
                                <div class="text-2xl font-semibold text-orange-400 mt-1" id="totalProposalsCount">
                                    0
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Historique global des propositions NutriChain.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">√âtat de la connexion Firestore</h3>
                                <div class="text-sm font-semibold text-red-400 mt-1" id="fallback-error-message">
                                    Mode statique (simulation DAO)
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Le chargement en temps r√©el peut √™tre d√©sactiv√© en dev.
                                </p>
                            </div>
                        </div>

                        <!-- BLOCS R√âCENTS & TOTAUX PAR R√âGION -->
                        <div class="stats-grid" style="margin-top: 1.5rem;">
                            <!-- Blocs r√©cents -->
                            <div class="stat-card col-span-1 md:col-span-2">
                                <h3 class="text-slate-400 text-sm mb-2">Blocs r√©cents NutriChain</h3>
                                <p class="text-xs text-slate-500 mb-2">
                                    Aper√ßu des derniers blocs min√©s sur NutriChain.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg">
                                        <thead class="bg-slate-900 text-slate-400">
                                        <tr>
                                            <th class="px-2 py-1 text-left">#</th>
                                            <th class="px-2 py-1 text-left">Hash</th>
                                            <th class="px-2 py-1 text-left">Tx</th>
                                            <th class="px-2 py-1 text-left">Date</th>
                                        </tr>
                                        </thead>
                                        <tbody id="blocksTableBody">
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">1</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xabc...123</td>
                                            <td class="px-2 py-1 border-t border-slate-800">3</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 14:00</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">2</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xdef...456</td>
                                            <td class="px-2 py-1 border-t border-slate-800">5</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 13:55</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">3</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xghi...789</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 13:50</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Totaux par r√©gion -->
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm mb-2">Totaux par r√©gion</h3>
                                <p class="text-xs text-slate-500 mb-2">
                                    Totaux agr√©g√©s √† partir des dons enregistr√©s sur NutriChain.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg">
                                        <thead class="bg-slate-900 text-slate-400">
                                        <tr>
                                            <th class="px-2 py-1 text-left">R√©gion</th>
                                            <th class="px-2 py-1 text-right">Repas financ√©s (NUTRI)</th>
                                        </tr>
                                        </thead>
                                        <tbody id="regionsTableBody">
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">Afrique Ouest</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">Afrique Est</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">Moyen-Orient</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-[11px] text-slate-500 mt-2">
                                    Chaque token = 1 repas distribu√©.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION CHAIN -->
                    <section id="chainSection" class="section mt-10">
                        <h2 class="text-xl font-semibold mb-4 text-white">Cha√Æne NCHAIN / blockchain</h2>
                        <p class="text-sm text-slate-400 mb-3">
                            D√©tails sur le token NCHAIN, le compte tr√©sorier et la lecture via Mirror Node.
                        </p>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>ID du token NCHAIN : 0.0.10136204</li>
                            <li>Compte tr√©sorier suivi : 0.0.10128148</li>
                            <li>Lecture des soldes via Mirror Node (lecture seule)</li>
                        </ul>
                    </section>

                    <!-- SECTION MAP -->
                    <section id="mapSection" class="section mt-10">
                        <h2 class="text-xl font-semibold mb-4 text-white">Carte des dons & cantines</h2>
                        <p class="text-sm text-slate-400 mb-3">
                            Localisation de quelques projets alimentaires soutenus par les dons NCHAIN.
                        </p>

                        <div class="relative">
                            <div id="map" class="cursor-pointer"></div>

                            <button
                              id="mapFullscreenBtn"
                              class="absolute top-2 right-2 z-20 px-2 py-1 rounded bg-black/60 text-xs text-white">
                                Plein √©cran
                            </button>
                        </div>

                        <div
                          id="mapOverlay"
                          class="fixed inset-0 z-40 bg-black/90 hidden">
                            <div class="absolute top-2 right-2">
                                <button
                                  id="mapOverlayClose"
                                  class="px-3 py-1 rounded bg-slate-800 text-xs text-white">
                                    Fermer
                                </button>
                            </div>
                            <div id="mapFullscreen" class="w-full h-full mt-8"></div>
                        </div>
                    </section>
                </main>
            </div>

            <!-- FOOTER -->
            <footer class="mt-12 pt-8 border-t border-[#30363d] text-center text-sm text-gray-400">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h4 class="text-white font-semibold mb-3">√Ä propos</h4>
                        <p class="text-gray-400">
                            NutriChain relie la transparence des tokens NCHAIN √† l‚Äôimpact r√©el en repas,
                            avec une gouvernance d√©centralis√©e et v√©rifiable.
                        </p>
                    </div>
                    <div>
                        <h4 class="text-white font-semibold mb-3">Ressources</h4>
                        <ul class="text-gray-400 space-y-1">
                            <li>Documentation technique</li>
                            <li>Explorateur Hedera</li>
                            <li>Interface de gouvernance</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="text-white font-semibold mb-3">Contact</h4>
                        <p class="text-gray-400 text-sm flex items-center justify-center">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i>contact@nutrichain.org
                        </p>
                    </div>
                </div>
                <div class="border-t border-[#30363d] pt-6">
                    <p>¬© 2025 NutriChain. Open Source MIT License.</p>
                </div>
            </footer>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
</script>

<script>
    let map;
    let fullscreenMap;

    async function loadNchainBalance(defaultAccount = "0.0.10128148") {
        try {
            const res = await fetch(`/nchain_balance/${defaultAccount}`);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            const el = document.getElementById('nchain-balance');
            if (el) {
                el.textContent = `${data.balance.toLocaleString('fr-FR')} ${data.symbol}`;
            }
            const impactEl = document.getElementById('impactMeals');
            if (impactEl) {
                impactEl.textContent = data.balance.toLocaleString('fr-FR');
            }
        } catch (e) {
            const el = document.getElementById('nchain-balance');
            if (el) el.textContent = 'Erreur de chargement';
            console.error('Error loading NCHAIN balance', e);
        }
    }

    const locations = [
        {lat: 48.8566, lng: 2.3522, name: 'Paris, France', meals: 127, org: 'Restos du C≈ìur'},
        {lat: 33.5138, lng: 36.2765, name: 'Damas, Syrie', meals: 50, org: 'Cantine Al-Amal'},
        {lat: 9.0320, lng: 38.7469, name: 'Addis-Abeba, √âthiopie', meals: 89, org: 'Programme WFP'},
        {lat: 28.6139, lng: 77.2090, name: 'New Delhi, Inde', meals: 234, org: 'Akshaya Patra'},
        {lat: -23.5505, lng: -46.6333, name: 'S√£o Paulo, Br√©sil', meals: 156, org: 'Banco de Alimentos'},
        {lat: 36.8065, lng: 10.1815, name: 'Tunis, Tunisie', meals: 78, org: 'Croissant Rouge'},
        {lat: 31.7917, lng: 35.2167, name: 'J√©rusalem', meals: 42, org: 'Leket Israel'},
        {lat: -4.0435, lng: 39.6682, name: 'Mombasa, Kenya', meals: 91, org: 'Food4Education'},
        {lat: 23.8103, lng: 90.4125, name: 'Dhaka, Bangladesh', meals: 203, org: 'BRAC'},
        {lat: 13.0827, lng: 80.2707, name: 'Chennai, Inde', meals: 167, org: 'Amma Canteen'},
        {lat: 6.5244, lng: 3.3792, name: 'Lagos, Nigeria', meals: 112, org: 'Food Bank Nigeria'},
        {lat: 33.8869, lng: 35.5131, name: 'Beyrouth, Liban', meals: 65, org: 'Secours Islamique'}
    ];

    function initMap() {
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        locations.forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng]).addTo(map);
            marker.bindPopup(`
                <div style="color: #e5e7eb;">
                    <strong>${loc.name}</strong><br>
                    <span style="color: #10b981;">üçΩÔ∏è ${loc.meals} repas distribu√©s</span><br>
                    <small>${loc.org}</small>
                </div>
            `);
        });
    }

    function setupMapFullscreen() {
        const btn = document.getElementById('mapFullscreenBtn');
        const overlay = document.getElementById('mapOverlay');
        const closeBtn = document.getElementById('mapOverlayClose');

        if (!btn || !overlay || !closeBtn) return;

        btn.addEventListener('click', () => {
            overlay.classList.remove('hidden');

            if (!fullscreenMap) {
                fullscreenMap = L.map('mapFullscreen').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(fullscreenMap);

                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(fullscreenMap);
                    marker.bindPopup(`
                        <div style="color: #e5e7eb;">
                            <strong>${loc.name}</strong><br>
                            <span style="color: #10b981;">üçΩÔ∏è ${loc.meals} repas distribu√©s</span><br>
                            <small>${loc.org}</small>
                        </div>
                    `);
                });
            }

            setTimeout(() => {
                fullscreenMap.invalidateSize();
            }, 200);
        });

        closeBtn.addEventListener('click', () => {
            overlay.classList.add('hidden');
        });
    }

    function setupWalletPrompt() {
        const btn = document.getElementById('connectWalletBtn');
        if (!btn) return;

        btn.addEventListener('click', async () => {
            const current = document.getElementById('userAddress')?.textContent || '';
            const accountId = prompt(
                "Entrez votre compte Hedera (ex: 0.0.123456)",
                current && current !== "Non Connect√©" ? current : ""
            );
            if (!accountId) return;

            const addrEl = document.getElementById('userAddress');
            if (addrEl) {
                addrEl.textContent = accountId;
            }

            await loadNchainBalance(accountId);
        });
    }

    function setupWalletConnectPlaceholder() {
        const btn = document.getElementById('wcConnectBtn');
        if (!btn) return;

        btn.addEventListener('click', () => {
            alert("Plus tard : ouverture du s√©lecteur WalletConnect multi-wallet (MetaMask, HashPack, Blade, etc.).");
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadNchainBalance();
        initMap();
        setupWalletPrompt();
        setupWalletConnectPlaceholder();
        setupMapFullscreen();
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
</body>
</html>
