<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NutriChain Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS (dev) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .nav-item {
            display: block;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        .nav-item:hover {
            background: #111827;
            color: #e5e7eb;
        }
        .nav-item.active {
            background: #111827;
            color: #f97316;
        }
        .dashboard-layout {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 768px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }
        .sidebar {
            border-right: 1px solid #1f2933;
            padding-right: 1rem;
        }
        @media (max-width: 768px) {
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #1f2933;
                padding-bottom: 1rem;
                margin-bottom: 1.5rem;
            }
        }
        .main-content {
            min-height: 0;
        }
        .stats-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
        .stat-card {
            background: #020617;
            border: 1px solid #1f2937;
            border-radius: 0.75rem;
            padding: 0.9rem 1rem;
        }
        #map {
            width: 100%;
            height: 360px;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            overflow: hidden;
        }
        #mapFullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
<div class="min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="border-b border-[#30363d] bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-lg bg-emerald-500/20 border border-emerald-500/40 flex items-center justify-center">
                    <span class="text-emerald-400 font-bold text-lg">N</span>
                </div>
                <div>
                    <h1 class="text-lg font-semibold tracking-tight text-white">NutriChain Dashboard</h1>
                    <p class="text-xs text-slate-400">
                        Tracking NCHAIN treasury, blocks, and distributed meals impact.
                    </p>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="flex-1 bg-slate-950">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="dashboard-layout">
                <!-- SIDEBAR -->
                <aside class="sidebar">
                    <h2 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wide">
                        Navigation
                    </h2>

                    <a href="#statsSection" class="nav-item active">Statistics</a>
                    <a href="#chainSection" class="nav-item">Chain / Treasury</a>
                    <a href="#mapSection" class="nav-item">Donations map</a>

                    <hr class="my-3 border-slate-800">

                    <a href="/donate" class="nav-item">Make a donation</a>
                    <a href="/stake" class="nav-item">Stake NUTRI</a>
                    <a href="/governance" class="nav-item">DAO governance</a>
                </aside>

                <!-- MAIN -->
                <main class="main-content">
                    <!-- STATS SECTION -->
                    <section id="statsSection" class="section">
                        <h2 class="text-xl font-semibold mb-4 text-white">Overview</h2>

                        <!-- ACTION BUTTONS -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <a href="/donate"
                               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold text-white">
                                <i data-lucide="donate" class="w-4 h-4"></i>
                                Make a donation
                            </a>

                            <a href="/stake"
                               class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold text-white">
                                <i data-lucide="layers" class="w-4 h-4"></i>
                                Stake NUTRI
                            </a>

                            <button
                              id="connectWalletBtn"
                              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-sm font-semibold text-gray-900">
                                <i data-lucide="plug-zap" class="w-4 h-4"></i>
                                Connect a Hedera wallet
                            </button>

                            <button
                              id="wcConnectBtn"
                              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-sm font-semibold text-gray-900">
                                <i data-lucide="wallet" class="w-4 h-4"></i>
                                Connect Wallet (WalletConnect)
                            </button>

                            <button
                              id="openNutriWalletBtn"
                              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-500 hover:bg-amber-400 text-sm font-semibold text-gray-900"
                              onclick="window.open('http://localhost:3000', '_blank')"
                            >
                                <i data-lucide="external-link" class="w-4 h-4"></i>
                                Open NutriChain wallet
                            </button>
                        </div>

                        <!-- MAIN STATS -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Meals distributed</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="mealsCount">12,847</div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Based on reported NCHAIN donations.
                                </p>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">NCHAIN treasury</h3>
                                <div class="text-2xl font-semibold text-emerald-400 mt-1" id="nchain-balance">Loading...</div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Balance of account 0.0.10128148
                                </p>
                            </div>
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Estimated impact</h3>
                                <div class="text-2xl font-semibold text-orange-400 mt-1">
                                    <span id="impactMeals">‚Äì</span> meals
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Indicative conversion NCHAIN ‚Üí meals.
                                </p>
                            </div>
                        </div>

                        <!-- GOVERNANCE SUMMARY -->
                        <div class="stats-grid" style="margin-top: 1.5rem;">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Your address</h3>
                                <div class="text-sm font-mono text-slate-300 mt-1" id="userAddress">
                                    Not connected
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Connect a compatible wallet to participate in governance.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">NUTRI price (USD)</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="nutri-price">
                                    N/A
                                </div>
                                <p class="text-xs text-slate-500 mt-1" id="nutriCoinSource">
                                    Indicative value of the NUTRI token.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Annual yield</h3>
                                <div class="text-2xl font-semibold text-emerald-400 mt-1" id="annualYield">
                                    7.25%
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Simulated APY for staking NUTRI.
                                </p>
                            </div>
                        </div>

                        <div class="stats-grid" style="margin-top: 1rem;">
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Your voting NUTRI</h3>
                                <div class="text-2xl font-semibold text-white mt-1" id="voting-power">
                                    0.00
                                </div>
                                <p class="text-xs text-slate-500 mt-1" id="userTokens">
                                    NUTRI counted for governance.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Total proposals submitted</h3>
                                <div class="text-2xl font-semibold text-orange-400 mt-1" id="totalProposalsCount">
                                    0
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Global history of NutriChain proposals.
                                </p>
                            </div>

                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm">Firestore connection status</h3>
                                <div class="text-sm font-semibold text-red-400 mt-1" id="fallback-error-message">
                                    Static mode (DAO simulation)
                                </div>
                                <p class="text-xs text-slate-500 mt-1">
                                    Real-time loading may be disabled in dev.
                                </p>
                            </div>
                        </div>

                        <!-- RECENT BLOCKS & REGIONAL TOTALS -->
                        <div class="stats-grid" style="margin-top: 1.5rem;">
                            <!-- Recent blocks -->
                            <div class="stat-card col-span-1 md:col-span-2">
                                <h3 class="text-slate-400 text-sm mb-2">Recent NutriChain blocks</h3>
                                <p class="text-xs text-slate-500 mb-2">
                                    Overview of the latest blocks on NutriChain.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg">
                                        <thead class="bg-slate-900 text-slate-400">
                                        <tr>
                                            <th class="px-2 py-1 text-left">#</th>
                                            <th class="px-2 py-1 text-left">Hash</th>
                                            <th class="px-2 py-1 text-left">Tx</th>
                                            <th class="px-2 py-1 text-left">Date</th>
                                        </tr>
                                        </thead>
                                        <tbody id="blocksTableBody">
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">1</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xabc...123</td>
                                            <td class="px-2 py-1 border-t border-slate-800">3</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 14:00</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">2</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xdef...456</td>
                                            <td class="px-2 py-1 border-t border-slate-800">5</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 13:55</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">3</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-xs">0xghi...789</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2</td>
                                            <td class="px-2 py-1 border-t border-slate-800">2025-12-03 13:50</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Totals by region -->
                            <div class="stat-card">
                                <h3 class="text-slate-400 text-sm mb-2">Totals by region</h3>
                                <p class="text-xs text-slate-500 mb-2">
                                    Aggregated totals from donations recorded on NutriChain.
                                </p>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs text-slate-300 border border-slate-800 rounded-lg">
                                        <thead class="bg-slate-900 text-slate-400">
                                        <tr>
                                            <th class="px-2 py-1 text-left">Region</th>
                                            <th class="px-2 py-1 text-right">Meals funded (NUTRI)</th>
                                        </tr>
                                        </thead>
                                        <tbody id="regionsTableBody">
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">West Africa</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">East Africa</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-1 border-t border-slate-800">Middle East</td>
                                            <td class="px-2 py-1 border-t border-slate-800 text-right">0</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p class="text-[11px] text-slate-500 mt-2">
                                    Each token = 1 meal distributed.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- CHAIN SECTION -->
                    <section id="chainSection" class="section mt-10">
                        <h2 class="text-xl font-semibold mb-4 text-white">NCHAIN chain / blockchain</h2>
                        <p class="text-sm text-slate-400 mb-3">
                            Details about the NCHAIN token, treasury account, and read-only access via Mirror Node.
                        </p>
                        <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                            <li>NCHAIN token ID: 0.0.10136204</li>
                            <li>Tracked treasury account: 0.0.10128148</li>
                            <li>Balances read via Mirror Node (read-only)</li>
                        </ul>
                        <p class="text-sm text-slate-400 mt-3">
                          Linked wallet:
                          <span id="linkedWalletSpan">unknown</span>
                        </p>
                    </section>

                    <!-- MAP SECTION -->
                    <section id="mapSection" class="section mt-10">
                        <h2 class="text-xl font-semibold mb-4 text-white">Donations & canteens map</h2>
                        <p class="text-sm text-slate-400 mb-3">
                            Location of some food projects supported by NCHAIN donations.
                        </p>

                        <div class="relative">
                            <div id="map" class="cursor-pointer"></div>

                            <button
                              id="mapFullscreenBtn"
                              class="absolute top-2 right-2 z-20 px-2 py-1 rounded bg-black/60 text-xs text-white">
                                Fullscreen
                            </button>
                        </div>

                        <div
                          id="mapOverlay"
                          class="fixed inset-0 z-40 bg-black/90 hidden">
                            <div class="absolute top-2 right-2">
                                <button
                                  id="mapOverlayClose"
                                  class="px-3 py-1 rounded bg-slate-800 text-xs text-white">
                                    Close
                                </button>
                            </div>
                            <div id="mapFullscreen" class="w-full h-full mt-8"></div>
                        </div>
                    </section>
                </main>
            </div>

            <!-- FOOTER -->
            <footer class="mt-16 border-t border-slate-800 bg-slate-950/80">
              <div class="mx-auto max-w-6xl px-4 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div class="text-xs text-slate-400">
                  <p class="font-semibold text-slate-200">NutriChain</p>
                  <p class="mt-1">
                    Transparent humanitarian treasury on Hedera.
                  </p>
                  <p class="mt-1">
                    ¬© 2025 NutriChain. All rights reserved.
                  </p>
                </div>

                <div class="flex items-center gap-5">
                  <!-- X -->
                  <a href="https://x.com/NutriChain"
                     target="_blank" rel="noopener noreferrer"
                     class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         class="h-5 w-5 fill-current">
                      <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.003-6.545-5.732 6.545H2.127l7.73-8.828L1.676 2.25h6.59l4.546 5.953 5.432-5.953z"/>
                    </svg>
                    <span>X</span>
                  </a>

                  <!-- Discord -->
                  <a href="https://discord.gg/TON_INVITE"
                     target="_blank" rel="noopener noreferrer"
                     class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 127.14 96.36"
                         class="h-5 w-5 fill-current">
                      <path d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,48,6.83,72.37,72.37,0,0,0,44.64,0,105.89,105.89,0,0,0,18.39,8.09C2.68,31.65-1.62,54.6.54,77.24A105.73,105.73,0,0,0,32.71,96.36,77.7,77.7,0,0,0,39.6,85.25,68.42,68.42,0,0,1,27.06,79.2c1.17-.84,2.31-1.7,3.41-2.59A70.38,70.38,0,0,0,50,84.41a70.53,70.53,0,0,0,19.57-7.8c1.11.9,2.25,1.76,3.42,2.59A68.23,68.23,0,0,1,60,85.28a77.25,77.25,0,0,0,6.89,11.11A105.25,105.25,0,0,0,99,77.24C101.46,51.63,95.14,29,107.7,8.07ZM42.52,65.69C36.73,65.69,32,60.38,32,54s4.59-11.74,10.48-11.74S53,47.6,53,54,48.31,65.69,42.52,65.69Zm42.1,0C78.83,65.69,74.1,60.38,74.1,54s4.58-11.74,10.47-11.74S95,47.6,95,54,90.35,65.69,84.62,65.69Z"/>
                    </svg>
                    <span>Discord</span>
                  </a>

                  <!-- Telegram -->
                  <a href="https://t.me/TON_TELEGRAM"
                     target="_blank" rel="noopener noreferrer"
                     class="inline-flex items-center gap-2 text-xs text-slate-400 hover:text-slate-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"
                         class="h-5 w-5 fill-current">
                      <path d="M120,0C53.73,0,0,53.73,0,120s53.73,120,120,120,120-53.73,120-120S186.27,0,120,0Zm58.42,82.27-18.9,89.2c-1.43,6.36-5.2,7.93-10.54,4.94l-29.1-21.45-14,13.49a7.35,7.35,0,0,1-5.88,2.87l2.1-29.82,54.27-49a2.47,2.47,0,0,0-3.05-3.9L84.63,130.07,55.7,121c-6.3-2-6.44-6.3,1.31-9.34l113.8-43.86C176.91,65.84,180.76,69.08,178.42,82.27Z"/>
                    </svg>
                    <span>Telegram</span>
                  </a>
                </div>
              </div>
            </footer>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
    let map;
    let fullscreenMap;

    async function loadNchainBalance(defaultAccount = "0.0.10128148") {
        try {
            const res = await fetch(`/nchain_balance/${defaultAccount}`);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            const el = document.getElementById('nchain-balance');
            if (el) {
                el.textContent = `${data.balance.toLocaleString('en-US')} ${data.symbol}`;
            }
            const impactEl = document.getElementById('impactMeals');
            if (impactEl) {
                impactEl.textContent = data.balance.toLocaleString('en-US');
            }
        } catch (e) {
            const el = document.getElementById('nchain-balance');
            if (el) el.textContent = 'Loading error';
            console.error('Error loading NCHAIN balance', e);
        }
    }

    const locations = [
        {lat: 48.8566, lng: 2.3522, name: 'Paris, France', meals: 127, org: 'Restos du C≈ìur'},
        {lat: 33.5138, lng: 36.2765, name: 'Damascus, Syria', meals: 50, org: 'Cantine Al-Amal'},
        {lat: 9.0320, lng: 38.7469, name: 'Addis Ababa, Ethiopia', meals: 89, org: 'WFP programme'},
        {lat: 28.6139, lng: 77.2090, name: 'New Delhi, India', meals: 234, org: 'Akshaya Patra'},
        {lat: -23.5505, lng: -46.6333, name: 'S√£o Paulo, Brazil', meals: 156, org: 'Banco de Alimentos'},
        {lat: 36.8065, lng: 10.1815, name: 'Tunis, Tunisia', meals: 78, org: 'Red Crescent'},
        {lat: 31.7917, lng: 35.2167, name: 'Jerusalem', meals: 42, org: 'Leket Israel'},
        {lat: -4.0435, lng: 39.6682, name: 'Mombasa, Kenya', meals: 91, org: 'Food4Education'},
        {lat: 23.8103, lng: 90.4125, name: 'Dhaka, Bangladesh', meals: 203, org: 'BRAC'},
        {lat: 13.0827, lng: 80.2707, name: 'Chennai, India', meals: 167, org: 'Amma Canteen'},
        {lat: 6.5244, lng: 3.3792, name: 'Lagos, Nigeria', meals: 112, org: 'Food Bank Nigeria'},
        {lat: 33.8869, lng: 35.5131, name: 'Beirut, Lebanon', meals: 65, org: 'Islamic Relief'}
    ];

    function initMap() {
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        locations.forEach(loc => {
            const marker = L.marker([loc.lat, loc.lng]).addTo(map);
            marker.bindPopup(`
                <div style="color: #e5e7eb;">
                    <strong>${loc.name}</strong><br>
                    <span style="color: #10b981;">üçΩÔ∏è ${loc.meals} meals distributed</span><br>
                    <small>${loc.org}</small>
                </div>
            `);
        });
    }

    function setupMapFullscreen() {
        const btn = document.getElementById('mapFullscreenBtn');
        const overlay = document.getElementById('mapOverlay');
        const closeBtn = document.getElementById('mapOverlayClose');

        if (!btn || !overlay || !closeBtn) return;

        btn.addEventListener('click', () => {
            overlay.classList.remove('hidden');

            if (!fullscreenMap) {
                fullscreenMap = L.map('mapFullscreen').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(fullscreenMap);

                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lng]).addTo(fullscreenMap);
                    marker.bindPopup(`
                        <div style="color: #e5e7eb;">
                            <strong>${loc.name}</strong><br>
                            <span style="color: #10b981;">üçΩÔ∏è ${loc.meals} meals distributed</span><br>
                            <small>${loc.org}</small>
                        </div>
                    `);
                });
            }

            setTimeout(() => {
                fullscreenMap.invalidateSize();
            }, 200);
        });

        closeBtn.addEventListener('click', () => {
            overlay.classList.add('hidden');
        });
    }

    function setupWalletPrompt() {
        const btn = document.getElementById('connectWalletBtn');
        if (!btn) return;

        btn.addEventListener('click', async () => {
            const current = document.getElementById('userAddress')?.textContent || '';
            const accountId = prompt(
                "Enter your Hedera account (e.g. 0.0.123456)",
                current && current !== "Not connected" ? current : ""
            );
            if (!accountId) return;

            const addrEl = document.getElementById('userAddress');
            if (addrEl) {
                addrEl.textContent = accountId;
            }

            await loadNchainBalance(accountId);
        });
    }

    function setupWalletConnectPlaceholder() {
        const btn = document.getElementById('wcConnectBtn');
        if (!btn) return;

        btn.addEventListener('click', () => {
            alert("Later: open the WalletConnect multi-wallet selector (MetaMask, HashPack, Blade, etc.).");
        });
    }

    async function loadLinkedWallet(accountId) {
        const span = document.getElementById("linkedWalletSpan");
        if (!span) return;

        const res = await fetch(`/linked_wallet/${accountId}`);
        const data = await res.json();

        if (!res.ok) {
            span.textContent = "No wallet linked";
            return;
        }

        span.textContent = `${data.account} ‚Üí ${data.evm_address}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadNchainBalance();
        initMap();
        setupWalletPrompt();
        setupWalletConnectPlaceholder();
        setupMapFullscreen();
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        // On ne spamme pas un accountId de test inexistant
        // loadLinkedWallet("0.0.7314686");
    });
</script>

<script>
    // Treasury account ID injected by Flask
    const treasuryId = "{{ treasury_id }}";

    // Get NCHAIN balance of the treasury (log debug)
    fetch(`/nchain_balance/${treasuryId}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`nchain_balance error: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        console.log("Treasury NCHAIN balance:", data);
      })
      .catch((err) => {
        console.error(err);
      });

    // Get a linked wallet (if any) for this account (log debug)
    fetch(`/linked_wallet/${treasuryId}`)
      .then((response) => {
        if (response.status === 404) {
          console.log("No wallet linked for this account");
          return null;
        }
        if (!response.ok) {
          throw new Error(`linked_wallet error: ${response.status}`);
        }
        return response.json();
      })
      .then((info) => {
        if (!info) return;
        console.log("Linked wallet:", info);
      })
      .catch((err) => {
        console.error(err);
      });
</script>
</body>
</html>

