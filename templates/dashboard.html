
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>NutriChain Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    /* Modale Web3Modal centr√©e */
    body w3m-modal {
      position: fixed !important; inset: 0 !important; display: flex !important;
      align-items: center !important; justify-content: center !important;
      z-index: 100000 !important; background: transparent !important;
    }
    body.w3m-open { overflow: hidden; }
    
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>

  <!-- Polyfills -->
  <script>
    window.global = window;
    window.process = { env: { NODE_ENV: "production" } };
  </script>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased selection:bg-emerald-500 selection:text-white">

  <div class="flex min-h-screen">
    
    <!-- MOBILE HEADER -->
    <div class="lg:hidden fixed top-0 left-0 right-0 bg-slate-900 border-b border-slate-800 p-4 flex items-center justify-between z-50 shadow-md">
      <div class="flex items-center gap-3">
        <img src="https://ipfs.io/ipfs/bafkreic4gnxl4l6lv7ycksqffykbpfq6ycvdqzuzzsn6q7wc4q5tzbmbsu" alt="NutriChain" class="h-8 w-8 rounded-full ring-2 ring-emerald-500/50">
        <span class="font-bold text-lg tracking-tight text-white">NutriChain</span>
      </div>
      <button id="wcConnectBtnMobile" class="text-xs bg-emerald-600 px-3 py-2 rounded text-white font-medium shadow-lg shadow-emerald-500/20">Connect</button>
    </div>

    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden lg:flex w-64 flex-col fixed inset-y-0 bg-slate-900 border-r border-slate-800 z-40">
      <div class="p-6 flex items-center gap-3 border-b border-slate-800/50">
        <img src="https://ipfs.io/ipfs/bafkreic4gnxl4l6lv7ycksqffykbpfq6ycvdqzuzzsn6q7wc4q5tzbmbsu" alt="NutriChain Logo" class="h-10 w-10 rounded-full shadow-lg ring-2 ring-emerald-500">
        <div>
          <h1 class="font-bold text-xl text-white tracking-tight">NutriChain</h1>
          <p class="text-[10px] text-emerald-400 font-medium tracking-wide uppercase">Decentralized Aid</p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1 mt-2">
        <a href="#" class="flex items-center gap-3 px-3 py-2.5 bg-emerald-500/10 text-emerald-400 rounded-lg font-medium transition-colors border border-emerald-500/20">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="#chainSection" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="link" class="w-5 h-5"></i> Chain Activity
        </a>
        <a href="#mapSection" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="map" class="w-5 h-5"></i> Donations Map
        </a>
        
        <div class="pt-6 mt-2">
          <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Actions</p>
          <a href="/wallet/" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
            <i data-lucide="wallet" class="w-4 h-4"></i> My Wallet
          </a>
          <a href="/donate" id="donateLink" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
            <i data-lucide="heart" class="w-4 h-4"></i> Make a Donation
          </a>
          <a href="/stake" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
            <i data-lucide="coins" class="w-4 h-4"></i> Stake NUTRI
          </a>
          <!-- Lien Sidebar mis √† jour vers Hashio -->
          <a href="/governance/app/governance-token/0.0.10146270/overview" target="_blank" id="governanceLink" class="flex items-center gap-3 px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
            <i data-lucide="vote" class="w-4 h-4"></i> Governance
          </a>
        </div>
      </nav>

      <div class="p-4 border-t border-slate-800/50 bg-slate-900/50">
        <div class="bg-slate-800/80 rounded-lg p-3 border border-slate-700/50">
          <p class="text-xs text-slate-400 mb-1">System Status</p>
          <div class="flex items-center gap-2">
            <span class="flex h-2 w-2 relative">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
            </span>
            <span class="text-xs font-medium text-emerald-400">Mainnet Active</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 lg:ml-64 p-4 lg:p-8 pt-20 lg:pt-8 bg-slate-950 flex flex-col">
      
      <!-- Top Bar -->
      <div class="hidden lg:flex justify-between items-center mb-8">
        <div>
          <h2 class="text-2xl font-bold text-white tracking-tight">Dashboard Overview</h2>
          <p class="text-slate-400 text-sm mt-1">Welcome back to the NutriChain ecosystem.</p>
        </div>
        <div class="flex items-center gap-4">
           <a href="https://saucerswap.finance/" target="_blank" class="px-4 py-2 text-sm font-medium text-emerald-400 bg-slate-900/50 hover:bg-slate-800 border border-emerald-500/30 rounded-lg transition-colors flex items-center gap-2">
             <i data-lucide="external-link" class="w-4 h-4"></i> Buy NCHAIN
           </a>
           <button id="wcConnectBtn" class="px-4 py-2 text-sm font-medium bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg shadow-lg shadow-emerald-500/20 transition-all flex items-center gap-2">
             <i data-lucide="wallet" class="w-4 h-4"></i> Connect Wallet
           </button>
        </div>
      </div>

      <div class="flex-1 flex flex-col">
        
        <!-- Stats Grid (maintenant 4 colonnes sur grand √©cran pour inclure la Governance) -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
          
          <!-- Card 1: Meals -->
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 p-4 opacity-5 group-hover:opacity-10 transition-opacity transform rotate-12">
              <i data-lucide="utensils" class="w-24 h-24 text-emerald-500"></i>
            </div>
            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Meals Distributed</h3>
            <p class="text-3xl font-bold text-white mt-2" id="mealsCount">12,847</p>
            <div class="mt-3 text-xs text-emerald-400 flex items-center gap-1 font-medium bg-emerald-500/10 px-2 py-1 rounded w-fit">
              <i data-lucide="trending-up" class="w-3 h-3"></i> +12% this week
            </div>
          </div>

          <!-- Card 2: Treasury -->
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 p-4 opacity-5 group-hover:opacity-10 transition-opacity transform rotate-12">
               <i data-lucide="landmark" class="w-24 h-24 text-blue-500"></i>
            </div>
            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">NCHAIN Treasury</h3>
            <p class="text-3xl font-bold text-white mt-2" id="nchain-balance">Loading...</p>
            <div class="mt-3 text-xs text-slate-400">Total locked value in vault</div>
          </div>

          <!-- Card 3: Impact -->
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl relative overflow-hidden group">
            <div class="absolute -right-4 -top-4 p-4 opacity-5 group-hover:opacity-10 transition-opacity transform rotate-12">
              <i data-lucide="sprout" class="w-24 h-24 text-orange-500"></i>
            </div>
            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Est. Impact</h3>
            <p class="text-3xl font-bold text-white mt-2" id="impactMeals">0</p>
            <div class="mt-3 text-xs text-slate-400">People helped globally</div>
          </div>

          <!-- Card 4: Governance (NOUVEAU) -->
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl relative overflow-hidden group">
             <div class="absolute -right-4 -top-4 p-4 opacity-5 group-hover:opacity-10 transition-opacity transform rotate-12">
               <i data-lucide="vote" class="w-24 h-24 text-purple-500"></i>
             </div>
             <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider flex justify-between items-center">
               Governance
               <span id="govStatus" class="px-2 py-0.5 rounded-full bg-slate-800 text-slate-400 text-[10px]">Inactive</span>
             </h3>
             <div class="mt-4">
               <h4 id="govTitle" class="text-sm font-bold text-white leading-tight">No active proposal</h4>
               <p id="govDesc" class="text-xs text-slate-400 mt-1 line-clamp-2">Community votes will appear here.</p>
             </div>
             <!-- Vote Bar Hidden by default -->
             <div class="mt-3 space-y-1 hidden" id="govStats">
                <div class="flex justify-between text-[10px] text-slate-400">
                  <span>Yes Votes</span>
                  <span id="voteYes">0%</span>
                </div>
                <div class="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden">
                  <div id="barYes" class="bg-purple-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
             </div>
             <div class="mt-4 pt-3 border-t border-slate-800/50">
               <a href="/governance/app/governance-token/0.0.10146270/overview" target="_blank" class="text-xs font-medium text-purple-400 hover:text-purple-300 flex items-center gap-1 transition-colors">
                 Go to Hashio DAO <i data-lucide="arrow-right" class="w-3 h-3"></i>
               </a>
             </div>
          </div>

        </div>

        <!-- Main Grid (Wallet / Tables / Map) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          
          <!-- WALLET & ACTIONS SECTION (Cols 2/3) -->
          <div class="lg:col-span-2 space-y-6">
            
            <!-- Wallet Card -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <div class="p-1.5 bg-emerald-500/10 rounded-lg">
                      <i data-lucide="wallet" class="w-5 h-5 text-emerald-400"></i>
                    </div>
                    Your NCHAIN Wallet
                  </h3>
                  <p class="text-slate-400 text-sm mt-1">Manage your assets and Hedera connection.</p>
                </div>
                <span id="userAddress" class="px-3 py-1 bg-slate-800 rounded-full text-xs font-mono text-slate-400 border border-slate-700">Not Connected</span>
              </div>
              
              <!-- Primary Actions -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <button onclick="if(window.currentEvmAddress) window.location.href='/donate?account='+window.currentEvmAddress; else window.location.href='/donate';" class="group relative flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white py-3 px-4 rounded-xl text-sm font-semibold transition-all overflow-hidden">
                  <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                  <i data-lucide="heart" class="w-4 h-4"></i> Make a Donation
                </button>
                <button onclick="if(window.currentEvmAddress) window.location.href='/stake?account='+window.currentEvmAddress; else window.location.href='/stake';" class="group relative flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white py-3 px-4 rounded-xl text-sm font-semibold transition-all border border-slate-700">
                  <i data-lucide="layers" class="w-4 h-4"></i> Manage Staking
                </button>
              </div>
              
              <!-- Link Hedera Logic -->
              <div class="border-t border-slate-800 pt-6">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                  <div>
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Linked Hedera ID</span>
                    <p class="text-xs text-slate-500">Connect EVM wallet, then link Hedera ID (0.0.xxxx).</p>
                  </div>
                  <div class="flex items-center gap-2 w-full sm:w-auto">
                    <input id="linkHederaInput" type="text" placeholder="0.0.xxxx" class="bg-slate-950 border border-slate-700 text-white text-xs rounded px-3 py-2 w-full sm:w-32 focus:ring-1 focus:ring-emerald-500 outline-none">
                    <button id="linkHederaBtn" class="bg-sky-600 hover:bg-sky-500 text-white px-3 py-2 rounded text-xs font-medium transition-colors">Link</button>
                  </div>
                </div>
                <p class="text-[10px] text-emerald-400 mt-2 text-right h-4" id="linkHederaStatus"></p>
              </div>
            </div>

            <!-- Totals by Region (Table) -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
              <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="globe" class="w-4 h-4 text-slate-400"></i> Totals by Region
              </h3>
              <div class="overflow-x-auto rounded-lg border border-slate-800">
                <table class="min-w-full text-xs text-left">
                  <thead class="bg-slate-950 text-slate-400 font-semibold uppercase tracking-wider">
                    <tr>
                      <th class="px-4 py-3">Region</th>
                      <th class="px-4 py-3 text-right">Meals Funded</th>
                    </tr>
                  </thead>
                  <tbody id="regionsTableBody" class="divide-y divide-slate-800 bg-slate-900 text-slate-300">
                    <tr>
                      <td class="px-4 py-3">West Africa</td>
                      <td class="px-4 py-3 text-right font-mono text-emerald-400">0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Recent Blocks (Table) -->
            <div id="chainSection" class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
              <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="box" class="w-4 h-4 text-slate-400"></i> Recent NutriChain Blocks
              </h3>
              <div class="overflow-x-auto rounded-lg border border-slate-800">
                <table class="min-w-full text-xs text-left">
                  <thead class="bg-slate-950 text-slate-400 font-semibold uppercase tracking-wider">
                    <tr>
                      <th class="px-4 py-3">#</th>
                      <th class="px-4 py-3">Hash</th>
                      <th class="px-4 py-3">Tx</th>
                      <th class="px-4 py-3 text-right">Time</th>
                    </tr>
                  </thead>
                  <tbody id="blocksTableBody" class="divide-y divide-slate-800 bg-slate-900 text-slate-300">
                    <tr>
                      <td class="px-4 py-3">1</td>
                      <td class="px-4 py-3 font-mono text-slate-500">0xabc...123</td>
                      <td class="px-4 py-3">3</td>
                      <td class="px-4 py-3 text-right text-slate-500">2 mins ago</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>

          <!-- RIGHT COL: ACTIVITY & MAP (Col 1/3) -->
          <div class="lg:col-span-1 space-y-6">
            
            <!-- LIVE ACTIVITY FEED -->
            <div class="bg-slate-900 border border-slate-800 rounded-xl shadow-xl flex flex-col max-h-[400px] overflow-hidden">
              <div class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wide">
                  <i data-lucide="activity" class="w-4 h-4 text-orange-400"></i>
                  Live Network
                </h3>
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
              </div>
              
              <div id="activityList" class="p-0 overflow-y-auto custom-scrollbar flex-1 bg-slate-900/30 min-h-[200px]">
                <div class="p-8 text-center">
                  <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-slate-600 mx-auto mb-2"></i>
                  <p class="text-slate-500 text-xs">Syncing network events...</p>
                </div>
              </div>
            </div>
            
            <!-- MAP SECTION -->
            <div id="mapSection" class="bg-slate-900 border border-slate-800 rounded-xl shadow-xl overflow-hidden relative group">
              <div class="p-4 border-b border-slate-800 flex justify-between items-center z-10 relative bg-slate-900">
                <h3 class="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wide">
                  <i data-lucide="map" class="w-4 h-4 text-blue-400"></i> Impact Map
                </h3>
                <button id="mapFullscreenBtn" class="text-xs bg-slate-800 hover:bg-slate-700 text-white px-2 py-1 rounded transition-colors border border-slate-700">Fullscreen</button>
              </div>
              <div id="map" class="h-64 w-full bg-slate-950 z-0"></div>
            </div>
            
            <!-- Info Panel -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
              <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">Chain Info</h4>
              <ul class="space-y-2 text-xs text-slate-300">
                <li class="flex justify-between"><span>Token ID</span> <span class="font-mono text-emerald-400">0.0.10136204</span></li>
                <li class="flex justify-between"><span>Treasury</span> <span class="font-mono text-slate-400">0.0.10128148</span></li>
                <li class="flex justify-between"><span>Status</span> <span class="text-green-500">Mirror Node OK</span></li>
              </ul>
            </div>

          </div>

        </div>

        <!-- Footer -->
        <footer class="mt-auto border-t border-slate-800 pt-6 pb-4">
          <div class="flex flex-col md:flex-row items-center justify-between gap-4 text-xs text-slate-500">
            <p class="text-center md:text-left">&copy; 2025 NutriChain Foundation ¬∑ Each token = 1 meal.</p>
            
            <div class="flex items-center gap-4">
              <!-- X / Twitter -->
              <a href="https://x.com/nutrichain_" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-slate-900 border border-slate-700 hover:border-emerald-500 hover:text-emerald-400 hover:bg-slate-800 transition-all"
                 title="X (Twitter)">
                <i data-lucide="twitter" class="w-4 h-4"></i>
              </a>
              <!-- Discord -->
              <a href="https://discord.gg/WYxT835A" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-slate-900 border border-slate-700 hover:border-indigo-400 hover:text-indigo-300 hover:bg-slate-800 transition-all"
                 title="Discord">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 245 240" class="w-4 h-4 fill-current">
                  <path d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.5-11.1-10.2-11.1z"/>
                  <path d="M189.5 20h-134C44.2 20 36 28.2 36 38.6v134.9c0 10.4 8.2 18.6 18.5 18.6h114.4l-5.3-18.5 12.8 11.9 12.1 11.2 21.5 19V38.6C210.1 28.2 201.9 20 191.5 20h-2zM160 149s-4.2-5.1-7.7-9.6c15.3-4.3 21.1-13.9 21.1-13.9-4.8 3.1-9.3 5.3-13.4 6.8-5.8 2.4-11.3 4-16.7 4.9-11 2.1-21.1 1.5-29.7-.1-6.5-1.2-12.1-2.8-16.8-4.9-2.6-1-5.4-2.2-8.2-3.7-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.2-1.8-1-2.8-1.7-2.8-1.7s5.6 9.3 20.4 13.7c-3.4 4.5-7.8 9.9-7.8 9.9-25.8-.8-35.6-17.7-35.6-17.7 0-37.6 16.8-68.1 16.8-68.1 16.8-12.6 32.8-12.2 32.8-12.2l1.2 1.4c-21 6-30.7 15.1-30.7 15.1s2.6-1.4 7-3.3c12.7-5.6 22.8-7.1 27-7.5.7-.1 1.3-.2 2-.2 7.2-.9 15.3-1.1 23.7-.2 11.1 1.3 23 4.5 35.2 11 0 0-9.2-8.7-29.1-14.7l1.7-1.9s16-.4 32.8 12.2c0 0 16.8 30.5 16.8 68.1 0-.1-9.8 16.8-35.6 17.6z"/>
                </svg>
              </a>
              <!-- Telegram -->
              <a href="https://t.me/NutriChainTeam" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-slate-900 border border-slate-700 hover:border-sky-400 hover:text-sky-300 hover:bg-slate-800 transition-all"
                 title="Telegram">
                <i data-lucide="send" class="w-4 h-4"></i>
              </a>
            </div>
          </div>
        </footer>
      </div>

    </main>
  </div>
  
  <!-- Fullscreen Map Overlay -->
  <div id="mapOverlay" class="fixed inset-0 z-[100] bg-black/95 hidden flex flex-col">
    <div class="p-4 flex justify-end">
      <button id="mapOverlayClose" class="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700">Close Map</button>
    </div>
    <div id="mapFullscreen" class="flex-1 w-full h-full"></div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Web3Modal (Ethers v4) -->
  <script type="module">
    import { createWeb3Modal, defaultConfig } from "https://esm.sh/@web3modal/ethers@4.0.0?bundle";

    const projectId = "6ada14d4e40d08d278a39c212bf50ce9";
    const mainnet = { chainId: 1, name: "Ethereum", currency: "ETH", explorerUrl: "https://etherscan.io", rpcUrl: "https://cloudflare-eth.com" };
    const metadata = { name: "NutriChain", description: "NutriChain Dashboard", url: "https://nutrichain.org", icons: ["https://ipfs.io/ipfs/bafkreic4gnxl4l6lv7ycksqffykbpfq6ycvdqzuzzsn6q7wc4q5tzbmbsu"] };

    let modal;
    window.currentEvmAddress = null;
    let currentStakingKey = null;
    let map, fullscreenMap;

    const locations = [
      { lat: 48.8566, lng: 2.3522, name: "Paris, France", meals: 127, org: "Restos du C≈ìur" },
      { lat: 33.5138, lng: 36.2765, name: "Damascus, Syria", meals: 50, org: "Cantine Al-Amal" },
      { lat: 9.032, lng: 38.7469, name: "Addis Ababa, Ethiopia", meals: 89, org: "WFP programme" },
      { lat: 28.6139, lng: 77.209, name: "New Delhi, India", meals: 234, org: "Akshaya Patra" }
    ];

    // -- 1. Governance Logic (DEMO MODE) --
    function loadGovernanceData() {
        // simulation
        const mockData = {
            active: true,
            title: "Proposal: Launch Liquidity Rewards",
            description: "Allocate 100k NCHAIN for LP rewards on SaucerSwap.",
            yesPercent: 88,
            status: "Voting Active"
        };

        if(mockData.active) {
            const statusEl = document.getElementById('govStatus');
            if(statusEl) {
              statusEl.innerText = mockData.status;
              statusEl.className = "px-2 py-0.5 rounded-full bg-purple-500/20 text-purple-400 text-[10px]";
            }
            
            if(document.getElementById('govTitle')) document.getElementById('govTitle').innerText = mockData.title;
            if(document.getElementById('govDesc')) document.getElementById('govDesc').innerText = mockData.description;
            
            const stats = document.getElementById('govStats');
            if(stats) {
                stats.classList.remove('hidden');
                document.getElementById('voteYes').innerText = mockData.yesPercent + "%";
                document.getElementById('barYes').style.width = mockData.yesPercent + "%";
            }
        }
    }

    // -- 2. Activity Feed Logic --
    async function loadActivityFeed() {
      try {
        const res = await fetch('/api/activity');
        const list = document.getElementById('activityList');
        if (!res.ok) throw new Error("No API");
        const data = await res.json();
        
        if(!data || data.length === 0) {
          list.innerHTML = '<div class="p-4 text-center text-slate-500 text-xs">No recent activity found.</div>';
          return;
        }
        list.innerHTML = data.map(item => `
          <div class="p-4 border-b border-slate-800 hover:bg-slate-800/40 transition-colors flex items-start gap-3 group">
            <div class="mt-1 p-1.5 rounded-full ${item.type === 'DONATION' ? 'bg-emerald-500/10 text-emerald-400' : (item.type === 'STAKE' ? 'bg-indigo-500/10 text-indigo-400' : 'bg-slate-700 text-slate-300')}">
              <i data-lucide="${item.type === 'DONATION' ? 'heart' : (item.type === 'STAKE' ? 'coins' : 'file-text')}" class="w-3.5 h-3.5"></i>
            </div>
            <div>
              <p class="text-sm text-slate-200 font-medium group-hover:text-white transition-colors">${item.description || 'New Action'}</p>
              <p class="text-[10px] text-slate-500 font-mono mt-0.5">${item.time || 'Just now'}</p>
            </div>
          </div>
        `).join('');
        if(window.lucide) window.lucide.createIcons();
      } catch(e) { 
        console.log("Activity feed silent fail");
      }
    }

    // -- 3. Map Logic --
    function initMap() {
      if(!document.getElementById('map')) return;
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
      }).addTo(map);
      
      locations.forEach(loc => {
        L.marker([loc.lat, loc.lng]).addTo(map)
          .bindPopup(`<div style="color:#333"><strong>${loc.name}</strong><br>üçΩÔ∏è ${loc.meals} meals</div>`);
      });
    }

    function setupMapFullscreen() {
      const btn = document.getElementById("mapFullscreenBtn");
      const overlay = document.getElementById("mapOverlay");
      const closeBtn = document.getElementById("mapOverlayClose");
      if (!btn || !overlay || !closeBtn) return;
  
      btn.addEventListener("click", () => {
        overlay.classList.remove("hidden");
        if (!fullscreenMap) {
          fullscreenMap = L.map("mapFullscreen").setView([20, 0], 2);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: "¬© OpenStreetMap", subdomains: 'abcd'
          }).addTo(fullscreenMap);
          locations.forEach((loc) => {
            L.marker([loc.lat, loc.lng]).addTo(fullscreenMap)
              .bindPopup(`<div style="color:#333"><strong>${loc.name}</strong><br>üçΩÔ∏è ${loc.meals} meals</div>`);
          });
        }
        setTimeout(() => fullscreenMap.invalidateSize(), 200);
      });
      closeBtn.addEventListener("click", () => overlay.classList.add("hidden"));
    }

    // -- 4. Web3Modal Logic --
    try {
      modal = createWeb3Modal({
        ethersConfig: defaultConfig({ metadata }),
        chains: [mainnet],
        projectId,
        enableAnalytics: true
      });

      const btn = document.getElementById("wcConnectBtn");
      const btnMobile = document.getElementById("wcConnectBtnMobile");
      async function openModal() { await modal.open(); }
      if(btn) btn.onclick = openModal;
      if(btnMobile) btnMobile.onclick = openModal;

      modal.subscribeProvider((state) => {
        if (state.isConnected && state.address) {
          window.currentEvmAddress = state.address;
          const userAddrEl = document.getElementById("userAddress");
          if(userAddrEl) userAddrEl.innerText = state.address.substring(0,6) + "..." + state.address.slice(-4);
          if(btn) btn.innerHTML = `<i data-lucide="user" class="w-4 h-4"></i> ${state.address.substring(0,4)}...`;
          
          fetch(`/api/evm_to_hedera?evm=${state.address}`)
            .then(r=>r.json())
            .then(d => {
              if(d.hedera) {
                document.getElementById('linkHederaStatus').innerText = `Linked to ${d.hedera}`;
                document.getElementById('linkHederaInput').value = d.hedera;
                currentStakingKey = d.hedera;
              }
            }).catch(()=>{});
        } else {
          window.currentEvmAddress = null;
          const userAddrEl = document.getElementById("userAddress");
          if(userAddrEl) userAddrEl.innerText = "Not Connected";
          if(btn) btn.innerHTML = `<i data-lucide="wallet" class="w-4 h-4"></i> Connect Wallet`;
          document.getElementById('linkHederaStatus').innerText = "";
        }
      });

    } catch (e) { console.error("Web3Modal Init Error", e); }
    
    // -- 5. Link Hedera Logic --
    function setupLinkHedera() {
      const btn = document.getElementById('linkHederaBtn');
      const input = document.getElementById('linkHederaInput');
      const status = document.getElementById('linkHederaStatus');
      if(!btn) return;
      
      btn.onclick = async () => {
        if(!window.currentEvmAddress) { status.innerText = "Connect EVM wallet first"; status.classList.add('text-rose-500'); return; }
        const hedera = input.value.trim();
        if(!/^0\.0\.\d+$/.test(hedera)) { status.innerText = "Invalid ID format (0.0.xxx)"; status.classList.add('text-rose-500'); return; }
        
        status.innerText = "Linking...";
        try {
          const res = await fetch("/api/link_hedera", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ evm: window.currentEvmAddress, hedera: hedera }),
          });
          const d = await res.json();
          if(d.error) throw new Error(d.error);
          status.innerText = "Success! Linked.";
          status.classList.remove('text-rose-500'); status.classList.add('text-emerald-400');
        } catch(e) {
          status.innerText = "Error: " + e.message;
          status.classList.add('text-rose-500');
        }
      };
    }

    // -- 6. Init on Load --
    document.addEventListener("DOMContentLoaded", () => {
      initMap();
      setupMapFullscreen();
      loadActivityFeed();
      setupLinkHedera();
      loadGovernanceData(); // Load Governance
      
      setInterval(loadActivityFeed, 10000); 
      if (typeof lucide !== "undefined") lucide.createIcons();  
      
      const treasuryId = "0.0.10128148";
      fetch(`/nchain_balance/${treasuryId}`)
        .then(r => r.ok ? r.json() : null)
        .then(d => {
          if(d && d.balance) {
            document.getElementById('nchain-balance').innerText = d.balance + " NCHAIN";
            const val = parseFloat(d.balance.replace(/,/g,''));
            document.getElementById('impactMeals').innerText = Math.floor(val / 100).toLocaleString();
          }
        }).catch(console.error);
    });

  </script>
</body>
</html>
