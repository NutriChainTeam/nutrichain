<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NutriChain - Make a donation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-xl mx-auto px-4 py-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-white">Make a NUTRI donation</h1>
      <a href="/" class="text-xs text-sky-400 hover:text-sky-300 flex items-center gap-1">
        <i data-lucide="arrow-left" class="w-3 h-3"></i> Back to dashboard
      </a>
    </header>

    <p class="text-xs text-slate-400 mb-4">
      Each NUTRI token = 1 meal distributed. The donation is sent onâ€‘chain via Hedera.
    </p>

    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
      <form id="donationForm" class="grid grid-cols-1 gap-3 text-xs">
        <div>
          <label class="block text-slate-400 mb-1">Donor address</label>
          <input id="donorWallet" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Your address (or off-chain identifier)" required />
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Donor name / label</label>
          <input id="donorLabel" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Optional (e.g. Anonymous, Foundation X)" />
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Target region</label>
          <select id="donationRegion"
                  class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                  required>
            <option value="">Choose a region</option>
            <option value="afrique_ouest">West Africa</option>
            <option value="afrique_est">East Africa</option>
            <option value="moyen_orient">Middle East</option>
            <option value="asie_sud">South Asia</option>
            <option value="afrique_centrale">Central Africa</option>
            <option value="afrique_nord">North Africa</option>
            <option value="Dakar">Dakar</option>
          </select>
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Amount (NUTRI)</label>
          <input id="donationAmount" type="number" min="1" step="1"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="e.g. 100" required />
        </div>

        <!-- Destination account -->
        <div>
          <label class="block text-slate-400 mb-1">Donation destination</label>
          <select id="beneficiaryType"
                  class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                  required>
            <option value="treasury">NutriChain Treasury (fees, reserve)</option>
            <option value="aid">NutriChain Aid Wallet (direct field support)</option>
          </select>
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Beneficiary Hedera account (0.0.x)</label>
          <input id="hederaAccount" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 value="0.0.10128148"
                 readonly />
          <p id="beneficiaryHelp" class="mt-1 text-[11px] text-slate-400">
            NutriChain Treasury: 0.0.10128148
          </p>
        </div>

        <div class="flex items-center justify-between gap-2 mt-1">
          <button type="submit"
                  class="px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white flex items-center gap-1">
            <i data-lucide="send" class="w-3 h-3"></i>
            Submit donation
          </button>
        </div>

        <p class="mt-2 text-[11px] text-slate-400">
          Step 1: this form records your donation intent on NutriChain (amount, region, destination).<br>
          Step 2: send the same amount in NCHAIN or HBAR
          to the Hedera account shown from your wallet (HashPack, etc.).
        </p>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) {
        window.lucide.createIcons();
      }

      const form = document.getElementById("donationForm");
      const beneficiaryType = document.getElementById("beneficiaryType");
      const hederaAccountInput = document.getElementById("hederaAccount");
      const beneficiaryHelp = document.getElementById("beneficiaryHelp");

      const TREASURY_ACCOUNT = "0.0.10128148";
      const AID_ACCOUNT = "0.0.10168905";

      function updateBeneficiary() {
        if (beneficiaryType.value === "aid") {
          hederaAccountInput.value = AID_ACCOUNT;
          beneficiaryHelp.textContent = "NutriChain Aid Wallet: 0.0.10168905";
        } else {
          hederaAccountInput.value = TREASURY_ACCOUNT;
          beneficiaryHelp.textContent = "NutriChain Treasury: 0.0.10128148";
        }
      }

      beneficiaryType.addEventListener("change", updateBeneficiary);
      updateBeneficiary();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          donor_wallet: document.getElementById("donorWallet").value,
          donor_label: document.getElementById("donorLabel").value,
          region: document.getElementById("donationRegion").value,
          amount_nutri: parseInt(document.getElementById("donationAmount").value, 10),
          hedera_account: hederaAccountInput.value,
          destination: beneficiaryType.value
        };

        try {
          const res = await fetch("http://127.0.0.1:5000/api/donate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error("Server error");
          }

          alert(
            "Step 1 OK: donation recorded on NutriChain for " +
            payload.hedera_account +
            ".\nStep 2: now send your NCHAIN/HBAR donation to this account from your Hedera wallet."
          );

          form.reset();
          beneficiaryType.value = "treasury";
          updateBeneficiary();
        } catch (err) {
          console.error(err);
          alert("Unable to record the donation for now. Please try again later.");
        }
      });
    });
  </script>
</body>
</html>

