<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>NutriChain - Faire un don</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-xl mx-auto px-4 py-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-white">Faire un don NUTRI</h1>
      <a href="/" class="text-xs text-sky-400 hover:text-sky-300 flex items-center gap-1">
        <i data-lucide="arrow-left" class="w-3 h-3"></i> Retour au dashboard
      </a>
    </header>

    <p class="text-xs text-slate-400 mb-4">
      Chaque token NUTRI = 1 repas distribué. Le don est envoyé on-chain via Hedera.
    </p>

    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
      <form id="donationForm" class="grid grid-cols-1 gap-3 text-xs">
        <div>
          <label class="block text-slate-400 mb-1">Adresse du donateur</label>
          <input id="donorWallet" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Votre adresse (ou identifiant off-chain)" required />
        </div>
        <div>
          <label class="block text-slate-400 mb-1">Nom / label Donateur</label>
          <input id="donorLabel" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Optionnel (ex : Anonyme, Fondation X)" />
        </div>
        <div>
          <label class="block text-slate-400 mb-1">Région ciblée</label>
          <select id="donationRegion"
                  class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                  required>
            <option value="">Choisir une région</option>
            <option value="afrique_ouest">Afrique Ouest</option>
            <option value="afrique_est">Afrique Est</option>
            <option value="moyen_orient">Moyen-Orient</option>
            <option value="asie_sud">Asie Sud</option>
            <option value="afrique_centrale">Afrique Centrale</option>
            <option value="afrique_nord">Afrique Nord</option>
            <option value="Dakar">Dakar</option>
          </select>
        </div>
        <div>
          <label class="block text-slate-400 mb-1">Montant (NUTRI)</label>
          <input id="donationAmount" type="number" min="1" step="1"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Ex : 100" required />
        </div>
        <div>
          <label class="block text-slate-400 mb-1">Compte Hedera bénéficiaire (0.0.x)</label>
          <input id="hederaAccount" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Compte Hedera recevant les NUTRI" required />
        </div>
        <div class="flex items-center justify-between gap-2 mt-1">
          <button type="submit"
                  class="px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white flex items-center gap-1">
            <i data-lucide="send" class="w-3 h-3"></i>
            Envoyer le don
          </button>
          <p id="donationStatus" class="text-[11px] text-slate-400"></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    async function setupDonationForm() {
      const form = document.getElementById('donationForm');
      if (!form) return;
      const statusEl = document.getElementById('donationStatus');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const wallet = donorWallet.value.trim();
        const label = donorLabel.value.trim() || 'Anonyme';
        const region = donationRegion.value;
        const amount = Number(donationAmount.value);
        const hederaAccount = hederaAccountInput.value.trim();

        if (statusEl) {
          statusEl.textContent = "Envoi du don en cours...";
          statusEl.className = "text-[11px] text-slate-400";
        }

        try {
          const res = await fetch('/donate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              wallet_address: wallet,
              donor_label: label,
              region,
              amount,
              hedera_account: hederaAccount
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Erreur lors du don');

          if (statusEl) {
            statusEl.textContent = `Don OK : ${data.amount} NUTRI pour ${data.region} (tx ${data.nchain_tx_status})`;
            statusEl.className = "text-[11px] text-emerald-400";
          }
        } catch (err) {
          console.error('Erreur don', err);
          if (statusEl) {
            statusEl.textContent = `Erreur : ${err.message}`;
            statusEl.className = "text-[11px] text-red-400";
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.donorWallet = document.getElementById('donorWallet');
      window.donorLabel = document.getElementById('donorLabel');
      window.donationRegion = document.getElementById('donationRegion');
      window.donationAmount = document.getElementById('donationAmount');
      window.hederaAccountInput = document.getElementById('hederaAccount');
      setupDonationForm();
      if (typeof lucide !== 'undefined') lucide.createIcons();
    });
  </script>
</body>
</html>
