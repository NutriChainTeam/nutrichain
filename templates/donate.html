<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>NutriChain - Make a donation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased">

  <div class="flex min-h-screen">
    
    <!-- SIDEBAR (Desktop) -->
    <aside class="hidden lg:flex w-64 flex-col fixed inset-y-0 bg-slate-900 border-r border-slate-800 z-40">
      <div class="p-6 flex items-center gap-3 border-b border-slate-800/50">
        <!-- LOGO IPFS -->
        <img src="https://ipfs.io/ipfs/bafkreic4gnxl4l6lv7ycksqffykbpfq6ycvdqzuzzsn6q7wc4q5tzbmbsu" alt="NutriChain Logo" class="h-10 w-10 rounded-full shadow-lg ring-2 ring-emerald-500">
        <div>
          <h1 class="font-bold text-xl text-white tracking-tight">NutriChain</h1>
          <p class="text-xs text-emerald-400 font-medium tracking-wide">DECENTRALIZED AID</p>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-1 mt-2">
        <a href="/" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
        </a>
        <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="check" class="w-5 h-5"></i> Admin
        </a>
        <a href="/governance" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="vote" class="w-5 h-5"></i> Governance
        </a>
        <a href="/stake" class="flex items-center gap-3 px-3 py-2.5 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors">
          <i data-lucide="layers" class="w-5 h-5"></i> Staking
        </a>
        <a href="/donate" class="flex items-center gap-3 px-3 py-2.5 bg-emerald-500/10 text-emerald-400 rounded-lg font-medium transition-colors border border-emerald-500/20">
          <i data-lucide="heart" class="w-5 h-5"></i> Donate
        </a>
      </nav>

      <div class="p-4 border-t border-slate-800/50 bg-slate-900/50">
        <div class="bg-slate-800/80 rounded-lg p-3 border border-slate-700/50">
          <p class="text-xs text-slate-400 mb-1">System Status</p>
          <div class="flex items-center gap-2">
            <span class="flex h-2 w-2 relative">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
            </span>
            <span class="text-xs font-medium text-emerald-400">Mainnet Active</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 lg:ml-64 p-4 lg:p-8 pt-20 lg:pt-8 bg-slate-950">
      
      <!-- Top Bar -->
      <div class="hidden lg:flex justify-between items-center mb-8">
        <div>
          <h2 class="text-2xl font-bold text-white tracking-tight">Make a NUTRI Donation</h2>
          <p class="text-slate-400 text-sm mt-1">Each NUTRI token â‰ˆ 1 meal distributed. Donations are sent on-chain via Hedera.</p>
        </div>
        <div class="flex items-center gap-4">
           <a href="/stake" class="px-4 py-2 text-sm font-medium text-emerald-400 bg-slate-900/50 hover:bg-slate-800 border border-emerald-500/30 rounded-lg transition-colors flex items-center gap-2">
             <i data-lucide="layers" class="w-4 h-4"></i> Staking
           </a>
           <a href="https://www.saucerswap.finance/swap/HBAR/0.0.10136204" target="_blank" class="px-4 py-2 text-sm font-medium bg-sky-600 hover:bg-sky-500 text-white rounded-lg transition-colors flex items-center gap-2">
             <i data-lucide="external-link" class="w-4 h-4"></i> Buy NCHAIN
           </a>
        </div>
      </div>

      <!-- Donation Form Card -->
      <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl max-w-2xl mx-auto">
        <form id="donationForm" class="grid grid-cols-1 gap-4 text-xs">
          <div>
            <label class="block text-slate-300 mb-1 text-xs font-semibold">Donor address (Hedera account)</label>
            <input id="donorWallet" type="text" placeholder="0.0.123456" class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" required />
          </div>

          <div>
            <label class="block text-slate-300 mb-1 text-xs font-semibold">Donor name / label</label>
            <input id="donorLabel" type="text" placeholder="Optional (e.g. Anonymous, Foundation X)" class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" />
          </div>

          <div>
            <label class="block text-slate-300 mb-1 text-xs font-semibold">Target region</label>
            <select id="donationRegion" class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" required>
              <option value="">Choose a region</option>
              <option value="afrique_ouest">West Africa</option>
              <option value="afrique_est">East Africa</option>
              <option value="moyen_orient">Middle East</option>
              <option value="asie_sud">South Asia</option>
              <option value="afrique_centrale">Central Africa</option>
              <option value="afrique_nord">North Africa</option>
              <option value="Dakar">Dakar</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-slate-300 mb-1 text-xs font-semibold">Amount (NUTRI)</label>
              <input id="donationAmount" type="number" min="1" step="1" placeholder="e.g. 100" class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" required />
            </div>
            <div>
              <label class="block text-slate-300 mb-1 text-xs font-semibold">Donation destination</label>
              <select id="beneficiaryType" class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" required>
                <option value="treasury">NutriChain Treasury (fees, reserve)</option>
                <option value="aid">NutriChain Aid Wallet (direct field support)</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-slate-300 mb-1 text-xs font-semibold">Beneficiary Hedera account (0.0.x)</label>
            <input id="hederaAccount" type="text" value="0.0.10128148" readonly class="w-full px-3 py-2 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" />
            <p id="beneficiaryHelp" class="mt-1 text-[11px] text-slate-400">NutriChain Treasury: 0.0.10128148</p>
          </div>

          <div class="flex items-center justify-between gap-2 mt-2">
            <button type="submit" class="px-4 py-2 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white flex items-center gap-2">
              <i data-lucide="send" class="w-3 h-3"></i> Submit donation
            </button>
          </div>

          <p class="mt-3 text-[11px] text-slate-400 leading-relaxed">
            This form records a donation with your Hedera account as both <code>wallet_address</code> and <code>hedera_account</code>. The backend then triggers an on-chain NCHAIN transfer when possible.
          </p>
        </form>
      </div>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script>
    function getQueryAccountId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("account") || "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) window.lucide.createIcons();

      const form = document.getElementById("donationForm");
      const beneficiaryType = document.getElementById("beneficiaryType");
      const hederaAccountInput = document.getElementById("hederaAccount");
      const beneficiaryHelp = document.getElementById("beneficiaryHelp");
      const donorWalletInput = document.getElementById("donorWallet");

      const TREASURY_ACCOUNT = "0.0.10128148";
      const AID_ACCOUNT = "0.0.10168905";

      const fromQuery = getQueryAccountId();
      if (donorWalletInput && fromQuery) {
        donorWalletInput.value = fromQuery;
      }

      function updateBeneficiary() {
        if (beneficiaryType.value === "aid") {
          hederaAccountInput.value = AID_ACCOUNT;
          beneficiaryHelp.textContent = "NutriChain Aid Wallet: 0.0.10168905";
        } else {
          hederaAccountInput.value = TREASURY_ACCOUNT;
          beneficiaryHelp.textContent = "NutriChain Treasury: 0.0.10128148";
        }
      }

      beneficiaryType.addEventListener("change", updateBeneficiary);
      updateBeneficiary();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const walletAddress = donorWalletInput.value.trim();
        if (!walletAddress) {
          alert("Please provide your Hedera account (donor address).");
          return;
        }

        const amountVal = parseInt(document.getElementById("donationAmount").value, 10);
        if (!Number.isFinite(amountVal) || amountVal <= 0) {
          alert("Please provide a valid donation amount (NUTRI).");
          return;
        }

        const payload = {
          wallet_address: walletAddress,
          donor_label: document.getElementById("donorLabel").value,
          region: document.getElementById("donationRegion").value,
          amount: amountVal,
          hedera_account: hederaAccountInput.value
        };

        try {
          const res = await fetch("/donate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (!res.ok) {
            console.error("Donate error payload:", data);
            alert(data.error || "Server error while recording the donation.");
            return;
          }

          alert(
            "Donation recorded:\n" +
            "- Amount: " + payload.amount + " NUTRI\n" +
            "- Region: " + payload.region + "\n" +
            "- Beneficiary: " + payload.hedera_account + "\n" +
            "On-chain status: " + (data.nchain_tx_status || "unknown")
          );

          form.reset();
          beneficiaryType.value = "treasury";
          updateBeneficiary();

          if (fromQuery && donorWalletInput) donorWalletInput.value = fromQuery;
        } catch (err) {
          console.error(err);
          alert("Unable to record the donation for now. Please try again later.");
        }
      });
    });
  </script>
</body>
</html>
