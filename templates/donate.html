<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>NutriChain - Faire un don</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-xl mx-auto px-4 py-6">
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-xl font-semibold text-white">Faire un don NUTRI</h1>
      <a href="/" class="text-xs text-sky-400 hover:text-sky-300 flex items-center gap-1">
        <i data-lucide="arrow-left" class="w-3 h-3"></i> Retour au dashboard
      </a>
    </header>

    <p class="text-xs text-slate-400 mb-4">
      Chaque token NUTRI = 1 repas distribué. Le don est envoyé on-chain via Hedera.
    </p>

    <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
      <form id="donationForm" class="grid grid-cols-1 gap-3 text-xs">
        <div>
          <label class="block text-slate-400 mb-1">Adresse du donateur</label>
          <input id="donorWallet" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Votre adresse (ou identifiant off-chain)" required />
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Nom / label Donateur</label>
          <input id="donorLabel" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Optionnel (ex : Anonyme, Fondation X)" />
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Région ciblée</label>
          <select id="donationRegion"
                  class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                  required>
            <option value="">Choisir une région</option>
            <option value="afrique_ouest">Afrique Ouest</option>
            <option value="afrique_est">Afrique Est</option>
            <option value="moyen_orient">Moyen-Orient</option>
            <option value="asie_sud">Asie Sud</option>
            <option value="afrique_centrale">Afrique Centrale</option>
            <option value="afrique_nord">Afrique Nord</option>
            <option value="Dakar">Dakar</option>
          </select>
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Montant (NUTRI)</label>
          <input id="donationAmount" type="number" min="1" step="1"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 placeholder="Ex : 100" required />
        </div>

        <!-- Choix du compte bénéficiaire -->
        <div>
          <label class="block text-slate-400 mb-1">Destination du don</label>
          <select id="beneficiaryType"
                  class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                  required>
            <option value="treasury">Trésorerie NutriChain (frais, réserve)</option>
            <option value="aid">NutriChain Aid Wallet (aide directe terrain)</option>
          </select>
        </div>

        <div>
          <label class="block text-slate-400 mb-1">Compte Hedera bénéficiaire (0.0.x)</label>
          <input id="hederaAccount" type="text"
                 class="w-full px-2 py-1 rounded-md bg-slate-950 border border-slate-700 text-slate-100 text-xs"
                 value="0.0.10128148"
                 readonly />
          <p id="beneficiaryHelp" class="mt-1 text-[11px] text-slate-400">
            Trésorerie NutriChain : 0.0.10128148
          </p>
        </div>

        <div class="flex items-center justify-between gap-2 mt-1">
          <button type="submit"
                  class="px-3 py-1.5 rounded-md bg-emerald-600 hover:bg-emerald-500 text-xs font-semibold text-white flex items-center gap-1">
            <i data-lucide="send" class="w-3 h-3"></i>
            Envoyer le don
          </button>
        </div>

        <p class="mt-2 text-[11px] text-slate-400">
          Étape 1 : ce formulaire enregistre votre intention de don côté NutriChain (montant, région, destination).<br>
          Étape 2 : envoyez le même montant en NCHAIN ou HBAR
          vers le compte Hedera indiqué depuis votre wallet (HashPack, etc.).
        </p>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) {
        window.lucide.createIcons();
      }

      const form = document.getElementById("donationForm");
      const beneficiaryType = document.getElementById("beneficiaryType");
      const hederaAccountInput = document.getElementById("hederaAccount");
      const beneficiaryHelp = document.getElementById("beneficiaryHelp");

      const TREASURY_ACCOUNT = "0.0.10128148";
      const AID_ACCOUNT = "0.0.10168905";

      function updateBeneficiary() {
        if (beneficiaryType.value === "aid") {
          hederaAccountInput.value = AID_ACCOUNT;
          beneficiaryHelp.textContent = "NutriChain Aid Wallet : 0.0.10168905";
        } else {
          hederaAccountInput.value = TREASURY_ACCOUNT;
          beneficiaryHelp.textContent = "Trésorerie NutriChain : 0.0.10128148";
        }
      }

      beneficiaryType.addEventListener("change", updateBeneficiary);
      updateBeneficiary();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = {
          donor_wallet: document.getElementById("donorWallet").value,
          donor_label: document.getElementById("donorLabel").value,
          region: document.getElementById("donationRegion").value,
          amount_nutri: parseInt(document.getElementById("donationAmount").value, 10),
          hedera_account: hederaAccountInput.value,
          destination: beneficiaryType.value
        };

        try {
          const res = await fetch("http://127.0.0.1:5000/api/donate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error("Erreur serveur");
          }

          alert(
            "Étape 1 OK : don enregistré côté NutriChain vers " +
            payload.hedera_account +
            ".\nÉtape 2 : envoyez maintenant votre don en NCHAIN/HBAR vers ce compte depuis votre wallet Hedera."
          );

          form.reset();
          beneficiaryType.value = "treasury";
          updateBeneficiary();
        } catch (err) {
          console.error(err);
          alert("Impossible d’enregistrer le don pour l’instant. Réessayez plus tard.");
        }
      });
    });
  </script>
</body>
</html>

