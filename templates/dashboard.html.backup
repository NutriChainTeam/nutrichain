<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NutriChain Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .nav-item.active {
            background: #111827;
            color: #f97316;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen flex flex-col">
        <!-- HEADER -->
        <header class="border-b border-[#30363d] bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950">
            <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="h-9 w-9 rounded-lg bg-emerald-500/20 border border-emerald-500/40 flex items-center justify-center">
                        <span class="text-emerald-400 font-bold text-lg">N</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold tracking-tight text-white">NutriChain Dashboard</h1>
                        <p class="text-xs text-slate-400">
                            Suivi de la tr√©sorerie NCHAIN et impact repas distribu√©s
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- CONTENU PRINCIPAL -->
        <div class="flex-1 bg-slate-950">
            <div class="max-w-6xl mx-auto px-4 py-6">
                <div class="dashboard-layout">
                    <!-- SIDEBAR -->
                    <aside class="sidebar">
                        <h2 class="text-sm font-semibold text-slate-400 mb-3 uppercase tracking-wide">
                            Navigation
                        </h2>
                        <a href="/stats" class="nav-item active">Statistiques</a>
                        <a href="/chain" class="nav-item">Cha√Æne / tr√©sorerie</a>
                        <a href="/donations/map" class="nav-item">Carte des dons</a>
                    </aside>

                    <!-- SECTIONS -->
                    <main class="main-content">
                        <!-- SECTION STATS -->
                        <section id="statsSection" class="section">
                            <h2 class="text-xl font-semibold mb-4 text-white">Vue d‚Äôensemble</h2>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <h3 class="text-slate-400 text-sm">Repas distribu√©s</h3>
                                    <div class="text-2xl font-semibold text-white mt-1" id="mealsCount">12 847</div>
                                    <p class="text-xs text-slate-500 mt-1">
                                        Bas√© sur les dons NCHAIN d√©clar√©s
                                    </p>
                                </div>
                                <div class="stat-card">
                                    <h3 class="text-slate-400 text-sm">Tr√©sorerie NCHAIN</h3>
                                    <div class="text-2xl font-semibold text-emerald-400 mt-1" id="nchain-balance">Chargement...</div>
                                    <p class="text-xs text-slate-500 mt-1">
                                        Solde du compte 0.0.10128148
                                    </p>
                                </div>
                                <div class="stat-card">
                                    <h3 class="text-slate-400 text-sm">Impact estim√©</h3>
                                    <div class="text-2xl font-semibold text-orange-400 mt-1">
                                        <span id="impactMeals">‚Äì</span> repas
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1">
                                        Conversion indicative NCHAIN ‚Üí repas
                                    </p>
                                </div>
                            </div>
                        </section>

                        <!-- SECTION CHAIN -->
                        <section id="chainSection" class="section" style="display:none;">
                            <h2 class="text-xl font-semibold mb-4 text-white">Cha√Æne NCHAIN / blockchain</h2>
                            <p class="text-sm text-slate-400 mb-3">
                                Ici, tu pourras d√©tailler les transactions NCHAIN, les comptes de tr√©sorerie,
                                et les liens vers les explorateurs Hedera.
                            </p>
                            <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
                                <li>ID du token NCHAIN : 0.0.10136204</li>
                                <li>Compte tr√©sorier suivi : 0.0.10128148</li>
                                <li>Lecture des soldes via Mirror Node (lecture seule)</li>
                            </ul>
                        </section>

                        <!-- SECTION MAP -->
                        <section id="mapSection" class="section" style="display:none;">
                            <h2 class="text-xl font-semibold mb-4 text-white">Carte des dons & cantines</h2>
                            <p class="text-sm text-slate-400">
                                Cette carte illustre quelques localisations de projets alimentaires o√π
                                les dons NCHAIN se traduisent en repas distribu√©s.
                            </p>
                            <div id="map"></div>
                        </section>
                    </main>
                </div>

                <!-- FOOTER -->
                <footer class="mt-10">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <div>
                            <h4 class="text-white font-semibold mb-3">√Ä propos</h4>
                            <p class="text-gray-400">
                                NutriChain relie la transparence des tokens NCHAIN √† l‚Äôimpact r√©el en repas,
                                avec une gouvernance d√©centralis√©e et v√©rifiable.
                            </p>
                        </div>
                        <div>
                            <h4 class="text-white font-semibold mb-3">Ressources</h4>
                            <ul class="text-gray-400 space-y-1">
                                <li>Documentation technique</li>
                                <li>Explorateur Hedera</li>
                                <li>Interface de gouvernance</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="text-white font-semibold mb-3">Contact</h4>
                            <p class="text-gray-400 text-sm flex items-center">
                                <i data-lucide="mail" class="w-4 h-4 mr-2"></i>contact@nutrichain.org
                            </p>
                        </div>
                    </div>
                    <div class="border-t border-[#30363d] pt-6 text-center text-sm text-gray-400">
                        <p>¬© 2025 NutriChain. Open Source MIT License.</p>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
    </script>

    <script>
        let map;

        function showSection(section) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(section + 'Section').style.display = 'block';
            event.target.classList.add('active');

            if (section === 'map' && !map) {
                initMap();
            }
        }

        async function loadNchainBalance() {
            try {
                const res = await fetch('/nchain_balance/0.0.10128148');
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                const el = document.getElementById('nchain-balance');
                if (!el) return;
                el.textContent = `${data.balance.toLocaleString('fr-FR')} ${data.symbol}`;
                const impactEl = document.getElementById('impactMeals');
                if (impactEl) {
                    impactEl.textContent = data.balance.toLocaleString('fr-FR');
                }
            } catch (e) {
                const el = document.getElementById('nchain-balance');
                if (el) el.textContent = 'Erreur de chargement';
                console.error('Error loading NCHAIN balance', e);
            }
        }

        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            const locations = [
                {lat: 48.8566, lng: 2.3522, name: 'Paris, France', meals: 127, org: 'Restos du C≈ìur'},
                {lat: 33.5138, lng: 36.2765, name: 'Damas, Syrie', meals: 50, org: 'Cantine Al-Amal'},
                {lat: 9.0320, lng: 38.7469, name: 'Addis-Abeba, √âthiopie', meals: 89, org: 'Programme WFP'},
                {lat: 28.6139, lng: 77.2090, name: 'New Delhi, Inde', meals: 234, org: 'Akshaya Patra'},
                {lat: -23.5505, lng: -46.6333, name: 'S√£o Paulo, Br√©sil', meals: 156, org: 'Banco de Alimentos'},
                {lat: 36.8065, lng: 10.1815, name: 'Tunis, Tunisie', meals: 78, org: 'Croissant Rouge'},
                {lat: 31.7917, lng: 35.2167, name: 'J√©rusalem', meals: 42, org: 'Leket Israel'},
                {lat: -4.0435, lng: 39.6682, name: 'Mombasa, Kenya', meals: 91, org: 'Food4Education'},
                {lat: 23.8103, lng: 90.4125, name: 'Dhaka, Bangladesh', meals: 203, org: 'BRAC'},
                {lat: 13.0827, lng: 80.2707, name: 'Chennai, Inde', meals: 167, org: 'Amma Canteen'},
                {lat: 6.5244, lng: 3.3792, name: 'Lagos, Nigeria', meals: 112, org: 'Food Bank Nigeria'},
                {lat: 33.8869, lng: 35.5131, name: 'Beyrouth, Liban', meals: 65, org: 'Secours Islamique'}
            ];

            locations.forEach(loc => {
                const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                marker.bindPopup(`
                    <div style="color: #e5e7eb;">
                        <strong>${loc.name}</strong><br>
                        <span style="color: #10b981;">üçΩÔ∏è ${loc.meals} repas distribu√©s</span><br>
                        <small>${loc.org}</small>
                    </div>
                `);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadNchainBalance();
            lucide.createIcons();
        });
    </script>
</body>
</html>
